%-----------------------
% C Weinschenk
% Verification of Extinction Model
% Fuel: Methane
% 6/2012
%-----------------------

clear all
close all

addpath('../../../Verification/Extinction/')

%-----------------------
% Initialize species
%-----------------------

%-------------
% vector key
% (1) = nitrogen
% (2) = methane
% (3) = oxygen
% (4) = carbon dioxide
% (5) = water vapor
%-------------
T_crit = 1600;          % critical flame temperature [K]
mass = 0.1;             % mass [kg]
volume = 0.001;         % volume [m^3]
R = 8.3145;             % gas constnat [J/mol K]


ran_num = [0.614193025281795,0.273280231245760,0.746706917123192,0.487871946746158,...
    0.792375493864710,0.524462895915340,0.597511525477123,0.220030197105833,...
    0.364019256716953,0.297242030695802,0.851616918974204,0.973689594593274,...
    0.623621604130313,0.892279193407138,0.980902708287649,0.646979104790480,...
    0.798818508157606,0.404874443888309,0.482364431286915,0.0638923592909068,...
    0.802928530818637,0.351070998819267,0.849272450184556,0.991807216382630,...
    0.484323954463190,0.356364595357585,0.0543710850399006,0.914077060021409,...
    0.704968741364115,0.438083604851226,0.968109025296514,0.723820838156331,...
    0.656803307680569,0.514771588938692,0.877056257493346,0.0601741606944168,...
    0.471477646995296,0.311016573938192,0.194693071729154,0.151049538868845,...
    0.901420404961970,0.0706582953484205,0.958387716954149,0.699889739577651,...
    0.0120096638883701,0.00488039931910367,0.853291397884026,0.467287774456014,...
    0.836718658877817,0.220624806883894,0.805960501451910,0.248579440740910,...
    0.998272611507824,0.937897628438129,0.553956353352095,0.912697424500699,...
    0.635489936226613,0.780095732356123,0.567218177239772,0.191761666926058,...
    0.906248331513915,0.514856417815248,0.998976311034164,0.377328665446907,...
    0.206111978117406,0.729946702724716,0.313435673302934,0.117580925647527,...
    0.888605592971567,0.693122898023161,0.939900141522557,0.417167317074028,...
    0.815770850199082,0.804842686588036,0.360404277019700,0.913814142909148,...
    0.288315832504754,0.165001861922716,0.455862510160389,0.242817315442618,...
    0.00192205255343114,0.615342876447461,0.661227860666023,0.660336428092937,...
    0.680475172422518,0.850649672812977,0.0373144684309216,0.680775196000538,...
    0.571137601206777,0.690214775346011,0.895566443250527,0.266862292427761,...
    0.0685546083682096,0.313601462605439,0.789179515820702,0.498339823066703,...
    0.437032740896536,0.168405698428294,0.264562676667796,0.683881583354393;];

ran_num2 = [0.816637406531762,0.705520989919261,0.576538892782125,0.994062492960322,...
    0.461193269888688,0.493353250001433,0.273959687386109,0.655102886737909,...
    0.407057092409188,0.299963138302547,0.605435572011172,0.791173272035512,...
    0.970893567879101,0.773383827316608,0.599981709687590,0.449068632784391,...
    0.153472770161465,0.211233003135498,0.700349041290390,0.956182186144888,...
    0.635468664889003,0.891271161381996,0.216285013698052,0.683543705465102,...
    0.315058619404266,0.0253865802689583,0.820249038054779,0.432668699121688,...
    0.0887066125846480,0.935083991453488,0.390776816002005,0.587931646455049,...
    0.239835941356027,0.653565004702233,0.366532483627925,0.481249932607441,...
    0.401685564357083,0.333797544152539,0.267585368411324,0.767842963639545,...
    0.240381918946828,0.961277161583316,0.923551261388231,0.274246913005953,...
    0.223278980867889,0.252123562882164,0.246993420297568,0.239576376998950,...
    0.428250960804787,0.825925886908257,0.617186241365241,0.193874402273731,...
    0.808081447291849,0.985634194254939,0.148602448431187,0.853030808041202,...
    0.238601950434642,0.416940550773971,0.322399902347060,0.434038639259104,...
    0.327423711634690,0.0989687826371550,0.671174399831591,0.0493586958059395,...
    0.200995885470055,0.499136927267249,0.275419317978240,0.419603922629909,...
    0.596992881985111,0.0491449094333751,0.886679430596533,0.858299166946022,...
    0.0850615500465453,0.177416773225097,0.0133985208033961,0.589985436037872,...
    0.707861993500709,0.758922559365245,0.213971293699592,0.966167268836941,...
    0.484388972423233,0.0624681010768420,0.178459197784273,0.338263383061555,...
    0.880482195056471,0.0427205478602680,0.355407416417742,0.640739324718760,...
    0.827883707476496,0.0446230145768678,0.790825634168463,0.0511506610896971,...
    0.296425847729493,0.272142381229007,0.913453811472951,0.605467095370523,...
    0.502217451311879,0.736600448720886,0.112123169605383,0.884489884652626;];

num_samp = 100;         % number of random input sets
ignite=zeros(num_samp,2);
extinct_o2=zeros(num_samp,2);
extinct_fuel=zeros(num_samp,2);

for i=1:num_samp
    phi_fuel(i) = ran_num(i); % initial mass fraction of fuel
    phi(i,:) = [0.77*(1-phi_fuel(i)); phi_fuel(i); 0.23*(1-phi_fuel(i)); 0.0; 0.0];  % initial mass fraction
    T0(i) = 300 + ran_num2(i)*1700; % initial temperature [K]
end

nu = [0; -1; -2; 1; 2]; % stoichiometric coefficients
y_MW = [28.0134; 16.042460; 31.9988; 44.0095; 18.01528]; % [g/mol]
y_hf = [0.0; -74873; 0.0; -393522; -241826]; % [J/mol]
pres_0 = 1.013253421185575e+05; % initial presure [Pa]
    
%-----------------------
% Determine max change in species
%-----------------------
for jj = 1:num_samp
    nu_mw_sum = 0;
    phi_sum = 0;

    for i=1:length(nu)
        if nu(i) < 0
            nu_mw_sum = nu_mw_sum + abs(nu(i))*y_MW(i);
            phi_sum = phi_sum + phi(jj,i);
        end
    end

    for i=1:length(nu)
        if nu(i) < 0
            phi_st(i) = abs(nu(i))*y_MW(i)/nu_mw_sum;
            phi_r(i) = phi(jj,i)/phi_sum;
        end
    end

    RR = phi_r./phi_st;
    ILR = 2;
    for i=3:length(nu)
        if nu(i) < 0
            if RR(i) < RR(ILR)
                ILR = i;
            end
        end
    end

    for i=1:length(nu)
        d_phi(jj,i) = nu(i)*y_MW(i)/(abs(nu(ILR))*y_MW(ILR))*phi(jj,ILR);
    end
    phi_new(jj,:) = phi(jj,:) + d_phi(jj,:);
    
    %-----------------------
    % Determine Extinction
    %-----------------------
        %---------
        %NOTE: coefficients were found from NIST Webbook
        %---------
        %reference temperature coeffs
        coeff_ref(:,1) = [28.98641;1.853978;-9.647459;16.63537;0.000117;-8.671914;0.0];
        coeff_ref(:,2) = [-0.703029;108.4773;-42.52157;5.862788;0.678565;-76.84376;-74.87310];
        coeff_ref(:,3) = [31.32234;-20.23531;57.86644;-36.50624;-0.007374;-8.903471;0.0];
        coeff_ref(:,4) = [24.99735;55.18696;-33.69137;7.948387;-0.136638;-403.6075;-393.5224];
        coeff_ref(:,5) = [30.09200;6.832514;6.793435;-2.534480;0.082139;-250.8810;-241.8264];   
        
        %initial temperature coeffs
        %nitrogen cp coeffs [J/mol K]
        if T0(jj) <=500
            coeff0(:,1) = [28.98641;1.853978;-9.647459;16.63537;0.000117;-8.671914;0.0]; 
        elseif 500 < T0(jj) <= 2000
            coeff0(:,1) = [19.50583;19.88705;-8.598535;1.369784;0.527601;-4.935202;0.0]; 
        else 
            coeff0(:,1) = [35.51872;1.128728;-0.196103;0.014662;-4.553760;-18.97091;0.0]; 
        end
        %methane cp coeffs [J/mol K]
        if T0(jj) <= 1300
            coeff0(:,2) = [-0.703029;108.4773;-42.52157;5.862788;0.678565;-76.84376;-74.87310];
        else
            coeff0(:,2) = [85.81217;11.26467;-2.114146;0.138190;-26.42221;-153.5327;-74.87310];
        end
        %oxygen cp coeffs [J/mol K]
        if T0(jj) <=700
            coeff0(:,3) = [31.32234;-20.23531;57.86644;-36.50624;-0.007374;-8.903471;0.0]; 
        elseif 700 < T0(jj) <= 2000
            coeff0(:,3) = [30.03235;8.772972;-3.988133;0.788313;-0.741599;-11.32468;0.0]; 
        else 
            coeff0(:,3) = [20.91111;10.72071;-2.020498;0.146449;9.245722;5.337651;0.0]; 
        end
        %carbon dooxide cp coeffs [J/mol K]
        if T0(jj) <= 1200
            coeff0(:,4) = [24.99735;55.18696;-33.69137;7.948387;-0.136638;-403.6075;-393.5224];    
        else    
            coeff0(:,4) = [58.16639;2.720074;-0.492289;0.038844;-6.447293;-425.9186;-393.5224];
        end    
        %water vapor cp coeffs [J/mol K] 
        if T0(jj) <= 1700
            coeff0(:,5) = [30.09200;6.832514;6.793435;-2.534480;0.082139;-250.8810;-241.8264];
        else
            coeff0(:,5) = [41.96246;8.622053;-1.499780;0.098199;-11.15764;-272.1797;-241.8264];
        end
        
        %critical temperature coeffs
        %nitrogen cp coeffs [J/mol K]
        if T_crit <=500
            coeff(:,1) = [28.98641;1.853978;-9.647459;16.63537;0.000117;-8.671914;0.0]; 
        elseif 500 < T_crit <= 2000
            coeff(:,1) = [19.50583;19.88705;-8.598535;1.369784;0.527601;-4.935202;0.0]; 
        else 
            coeff(:,1) = [35.51872;1.128728;-0.196103;0.014662;-4.553760;-18.97091;0.0]; 
        end
        %methane cp coeffs [J/mol K]
        if T_crit <= 1300
            coeff(:,2) = [-0.703029;108.4773;-42.52157;5.862788;0.678565;-76.84376;-74.87310];
        else
            coeff(:,2) = [85.81217;11.26467;-2.114146;0.138190;-26.42221;-153.5327;-74.87310];
        end
        %oxygen cp coeffs [J/mol K]
        if T_crit <=700
            coeff(:,3) = [31.32234;-20.23531;57.86644;-36.50624;-0.007374;-8.903471;0.0]; 
        elseif 700 < T_crit <= 2000
            coeff(:,3) = [30.03235;8.772972;-3.988133;0.788313;-0.741599;-11.32468;0.0]; 
        else 
            coeff(:,3) = [20.91111;10.72071;-2.020498;0.146449;9.245722;5.337651;0.0]; 
        end
        %carbon dooxide cp coeffs [J/mol K]
        if T_crit <= 1200
            coeff(:,4) = [24.99735;55.18696;-33.69137;7.948387;-0.136638;-403.6075;-393.5224];    
        else    
            coeff(:,4) = [58.16639;2.720074;-0.492289;0.038844;-6.447293;-425.9186;-393.5224];
        end    
        %water vapor cp coeffs [J/mol K] 
        if T_crit <= 1700
            coeff(:,5) = [30.09200;6.832514;6.793435;-2.534480;0.082139;-250.8810;-241.8264];
        else
            coeff(:,5) = [41.96246;8.622053;-1.499780;0.098199;-11.15764;-272.1797;-241.8264];
        end
        t=T_crit/1000;
        t0=T0(jj)/1000;
        for i=1:5
            del_h_init(i) = 1000*(coeff0(1,i)*t0 + (1/2)*coeff0(2,i)*t0^2 + (1/3)*coeff0(3,i)*t0^3 + (1/4)*coeff0(4,i)*t0^4 - coeff0(5,i)/t0 + coeff0(6,i) - coeff0(7,i));
            del_h(i) = 1000*(coeff(1,i)*t + (1/2)*coeff(2,i)*t^2 + (1/3)*coeff(3,i)*t^3 + (1/4)*coeff(4,i)*t^4 - coeff(5,i)/t + coeff(6,i) - coeff(7,i));
        end

        Q(jj) = 0;
        h = 0;
        h0 = 0;
        for i=1:length(y_hf)
            Q(jj) = Q(jj) - y_hf(i)*d_phi(jj,i)/y_MW(i);
            h0 = h0 +phi(jj,i).*del_h_init(i)/y_MW(i);
            h = h + phi(jj,i).*del_h(i)/y_MW(i);
        end           
    
    if h0 + Q(jj)  > h
        ignite(jj,:) = [T0(jj);phi(jj,3)];
    else
%         if ILR == 2
%             extinct_fuel(jj,:) = [T0(jj);phi(jj,3)];
%         else
            extinct_o2(jj,:) = [T0(jj);phi(jj,3)];  
%         end
    end
end

mowrer_temp = [300,1700];
mowrer_yo2 = [0.15,0.0];

%-----------------------
% Import FDS results
%-----------------------
epsilon = 1e-10;

Extinction_2=importdata('Extinction_devc.csv');
extinct_2(:,:)=Extinction_2.data; % data

for i=1:100
   hrr_ext(:,i) = extinct_2(:,4*i-2);
   temp_ext(:,i) = extinct_2(:,4*i-1)+273.15;
   o2_ext(:,i) = extinct_2(:,4*i);
   fu_ext(:,i) = extinct_2(:,4*i+1);
end

for i=1:100
    if sum(hrr_ext(:,i)) > epsilon
        fds_ignite(i,:) = [temp_ext(1,i);o2_ext(1,i)];
    else
        fds_ext_o2(i,:) = [temp_ext(1,i);o2_ext(1,i)];
    end
end


%-----------------------
% Plotting
%-----------------------
figure(1)
plot(mowrer_temp,mowrer_yo2,'k',ignite(:,1),ignite(:,2),'rs',fds_ignite(:,1),fds_ignite(:,2),'m+',extinct_o2(:,1),extinct_o2(:,2),'bo',fds_ext_o2(:,1),fds_ext_o2(:,2),'m*')
axis([298.15 2000 0 0.25 ])
MarkerSize = 7;
LineWidth = 1.5;
plot_style
set(gca,'Units',Plot_Units)
set(gca,'FontName',Font_Name)
set(gca,'Position',[Scat_Plot_X,Scat_Plot_Y,Scat_Plot_Width,Scat_Plot_Height])
xlabel('Temperature (K)','Interpreter',Font_Interpreter,'FontSize',Scat_Label_Font_Size,'FontName',Font_Name)
ylabel('Mass Fraction Oxygen','Interpreter',Font_Interpreter,'FontSize',Scat_Label_Font_Size,'FontName',Font_Name)
legend('Mowrer','Expected Ignition','FDS Ignition','Expected Extinction','FDS Extinction','Location','NorthEast')

% add SVN if file is available

svn_file = 'Extinction_svn.txt';

if exist(svn_file,'file')
    SVN = importdata(svn_file);
    x_lim = get(gca,'XLim');
    y_lim = get(gca,'YLim');
    X_SVN_Position = x_lim(1)+SVN_Scale_X*(x_lim(2)-x_lim(1));
    Y_SVN_Position = y_lim(1)+SVN_Scale_Y*(y_lim(2)-y_lim(1));
    text(X_SVN_Position,Y_SVN_Position,['SVN ',num2str(SVN)], ...
        'FontSize',10,'FontName',Font_Name,'Interpreter',Font_Interpreter)
end

% print to pdf
set(gcf,'Visible',Figure_Visibility);
set(gcf,'PaperUnits',Paper_Units);
set(gcf,'PaperSize',[Scat_Paper_Width Scat_Paper_Height]);
set(gcf,'PaperPosition',[0 0 Scat_Paper_Width Scat_Paper_Height]);
print(gcf,'-dpdf','../../../Manuals/FDS_Verification_Guide/SCRIPT_FIGURES/Extinction');
