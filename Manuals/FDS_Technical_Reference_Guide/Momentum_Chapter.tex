\chapter{Momentum Transport and Pressure}
\label{momentum_chapter}

This chapter describes the solution of the momentum equation. This consists of two major parts -- the
discretization of the flux terms and then the solution of an elliptic partial differential equation for the
pressure.

\section{Simplifying the Momentum Equation}

First, we start with the non-conservative form of the momentum equation introduced above
\be \rho \left( \dod{\bu}{t} + (\bu \cdot \nabla)\bu  \right) + \nabla p = \rho \bg + \bof_b + \nabla\!\cdot \btau_{ij}  \label{momentum} \ee
Next, we make the following substitutions:
\begin{enumerate}
\item Subtract the hydrostatic pressure gradient of the $n$th pressure zone, $\rho_n(z,t) \bg$, from both sides. Note that
$\nabla p=\rho_n \bg + \nabla \tp$.
\item Apply the vector identity: $(\bu \cdot \nabla) \bu = \nabla|\bu|^2/2 - \bu\times\bo $
\item Divide all terms by the density, $\rho$
\item Decompose the pressure term:
   $$ \frac{1}{\rho} \nabla \tp = \nabla \left( \frac{\tp}{\rho}\right) - \tp \nabla \left(\frac{1}{\rho} \right)  $$
\item Define ${\cal H} \equiv |\bu|^2/2 + \tp/\rho $
\end{enumerate}
Now the momentum equation can be written
\be \dod{\bu}{t} - \bu\times\bo + \nabla {\cal H} - \tp \nabla \left( \frac{1}{\rho}\right) = \frac{1}{\rho} \Big[ (\rho-\rho_n) \bg
+ \bof_b + \nabla\!\cdot \btau_{ij} \Big]  \label{momeq} \ee
It is convenient to write this equation in the form:
\be \dod{\bu}{t} + \bF + \nabla \cH = 0 \label{simple_momentum_equation} \ee
The vector $\bF$ is referred to collectively as the momentum flux terms, and the term $\nabla \cH$ is referred to as the
pressure gradient. The spatial discretization of the momentum equations takes the form
\begin{eqnarray}
\dod{\hu}{t} + F_{\x,ijk} + \frac{\hp_{i+1,jk} -\hp_{ijk}}{\dx} = 0  \label{umom} \\
\dod{\hv}{t} + F_{\y,ijk} + \frac{\hp_{i,j+1,k}-\hp_{ijk}}{\dy} = 0  \label{vmom} \\
\dod{\hw}{t} + F_{\z,ijk} + \frac{\hp_{ij,k+1} -\hp_{ijk}}{\dz} = 0  \label{wmom}
\end{eqnarray}
where $\hp_{ijk}$ is taken at center of cell $ijk$,
$\hu_{ijk}$ and $F_{\x,ijk}$ are taken at the side of the cell facing
in the forward $x$ direction, $\hv_{ijk}$ and $F_{\y,ijk}$ at the side
facing in the forward $y$ direction, and $\hw_{ijk}$ and $F_{\z,ijk}$
at the side facing in the forward $z$ (vertical) direction.
The flux terms are discretized:
\begin{eqnarray}
F_x &=& \hw \, \omy - \hv \, \omz - \frac{1}{\rho} \left( f_x
  +  \dod{\tau_{xx}}{x} + \dod{\tau_{xy}}{y} + \dod{\tau_{xz}}{z} \right) \\
F_y &=& \hu \, \omz - \hw \, \omx - \frac{1}{\rho} \left( f_y
  +  \dod{\tau_{yx}}{x} + \dod{\tau_{yy}}{y} + \dod{\tau_{yz}}{z} \right) \\
F_z &=& \hv \, \omx - \hu \, \omy - \frac{1}{\rho} \left( f_z
  +  \dod{\tau_{zx}}{x} + \dod{\tau_{zy}}{y} + \dod{\tau_{zz}}{z} \right)
\end{eqnarray}
In the
definitions to follow, the components of the vorticity $(\om_x,\om_y,\om_z)$
are located at cell edges pointing in the $x$, $y$ and $z$ directions,
respectively. The same is true for the off-diagonal terms of the viscous
stress tensor: $\tau_{zy}=\tau_{yz}$, $\tau_{xz}=\tau_{zx}$, and
$\tau_{xy}=\tau_{yx}$. The diagonal components of the stress
tensor $\tau_{xx}$, $\tau_{yy}$, and $\tau_{zz}$; the external force
components $(f_x,f_y,f_z)$; and the Courant numbers
$\epsilon_u$, $\epsilon_v$, and $\epsilon_w$ are located at their
respective cell faces.
\begin{align}
F_{\x,ijk} &=  \left(
 \frac{1\mp\epsilon_w}{2} w_{i+\ha,jk} \; \om_{y,ijk} +
 \frac{1\pm\epsilon_w}{2} w_{i+\ha,j,k-1} \; \om_{y,ij,k-1} \right) \nonumber \\
          &  - \left(
 \frac{1\mp\epsilon_v}{2} v_{i+\ha,jk} \; \om_{z,ijk} +
 \frac{1\pm\epsilon_v}{2} v_{i+\ha,j-1,k} \; \om_{z,i,j-1,k} \right) \nonumber\\
           &  - \frac{1}{\rho_{i+\ha,jk}} \left( f_{x,ijk}
  + \frac{\tau_{xx,i+1,jk}-\tau_{xx,ijk}}{\dx}
  + \frac{\tau_{xy,ijk}-\tau_{xy,i,j-1,k}}{\dy}
  + \frac{\tau_{xz,ijk}-\tau_{xz,i,j,k-1}}{\dz}  \right)  \\
F_{\y,ijk} &= \left(
 \frac{1\mp\epsilon_u}{2} u_{i,j+\ha,k} \; \om_{z,ijk} +
 \frac{1\pm\epsilon_u}{2} u_{i-1,j+\ha,k} \; \om_{z,i-1,jk} \right) \nonumber \\
           &  - \left(
 \frac{1\mp\epsilon_w}{2} w_{i,j+\ha,k} \; \om_{x,ijk}+
 \frac{1\pm\epsilon_w}{2} w_{i,j+\ha,k-1} \; \om_{x,ij,k-1} \right) \nonumber \\
           &  - \frac{1}{\rho_{i,j+\ha,k}} \left( f_{y,ijk}
  + \frac{\tau_{yx,ijk}-\tau_{yx,i-1,jk}}{\dx}
  + \frac{\tau_{yy,i,j+1,k}-\tau_{yy,ijk}}{\dy}
  + \frac{\tau_{yz,ijk}-\tau_{yz,i,j,k-1}}{\dz} \right) \\
F_{\z,ijk} &=  \left(
 \frac{1\mp\epsilon_v}{2} v_{ij,k+\ha} \; \om_{x,ijk} +
 \frac{1\pm\epsilon_v}{2} v_{i,j-1,k+\ha} \; \om_{x,i,j-1,k} \right)\nonumber \\
           &  -\left(
 \frac{1\mp\epsilon_u}{2} u_{ij,k+\ha} \; \om_{y,ijk} +
 \frac{1\pm\epsilon_u}{2} u_{i-1,j,k+\ha} \; \om_{y,i-1,jk} \right) \nonumber \\
           &  - \frac{1}{\rho_{ij,k+\ha}} \left( f_{z,ijk}
  + \frac{\tau_{zx,ijk}-\tau_{zx,i-1,jk}}{\dx}
  + \frac{\tau_{zy,ijk}-\tau_{zy,i,j-1,k}}{\dy}
  + \frac{\tau_{zz,ij,k+1}-\tau_{zz,ijk}}{\dz} \right)
\end{align}

\noindent The components of the vorticity vector are:
\begin{align}
\om_{x,ijk} &= \frac{\hw_{i,j+1,k}-\hw_{ijk}}{\dy} -
             \frac{\hv_{ij,k+1}-\hv_{ijk}}{ \dz}  \\
\om_{y,ijk} &= \frac{\hu_{ij,k+1}-\hu_{ijk}}{\dz} -
             \frac{\hw_{i+1,jk}-\hw_{ijk}}{\dx}  \\
\om_{z,ijk} &= \frac{\hv_{i+1,jk}- \hv_{ijk}}{\dx} -
             \frac{\hu_{i,j+1,k}-\hu_{ijk}}{ \dy}
\end{align}
\noindent The components of the viscous stress tensor are:
\begin{align}
\tau_{xx,ijk} &= \mu_{ijk} \left( \ft (\nabla\!\cdot \bu)_{ijk} - 2 \frac{v_{ijk}-v_{i,j-1,k}}{\dy} - 2 \frac{w_{ijk}-w_{ij,k-1}}{\dz} \right)  \\
\tau_{yy,ijk} &= \mu_{ijk} \left( \ft (\nabla\!\cdot \bu)_{ijk} - 2 \frac{u_{ijk}-u_{i-1,jk}}{\dx}  - 2 \frac{w_{ijk}-w_{ij,k-1}}{\dz} \right)  \\
\tau_{zz,ijk} &= \mu_{ijk} \left( \ft (\nabla\!\cdot \bu)_{ijk} - 2 \frac{u_{ijk}-u_{i-1,jk}}{\dx}  - 2 \frac{v_{ijk}-v_{i,j-1,k}}{\dy} \right)  \\
\tau_{xy,ijk} &= \tau_{yx,ijk}
        = \mu_{i+\ha,j+\ha,k} \left( \frac{u_{i,j+1,k}-u_{ijk}}{\dy}
                         + \frac{v_{i+1,jk} -v_{ijk}}{\dx} \right) \\
\tau_{xz,ijk} &= \tau_{zx,ijk}
        =\mu_{i+\ha,j,k+\ha} \left( \frac{u_{ij,k+1}-u_{ijk}}{\dz}
                        + \frac{w_{i+1,jk}-w_{ijk}}{\dx} \right) \\
\tau_{yz,ijk} &= \tau_{zy,ijk}
        =\mu_{i,j+\ha,k+\ha} \left( \frac{v_{ij,k+1}-v_{ijk}}{\dz}
                        + \frac{w_{i,j+1,k}-w_{ijk}}{\dy} \right)
\end{align}

\noindent The variables $\epsilon_u$, $\epsilon_v$ and $\epsilon_w$ are local
Courant numbers evaluated at the same locations as the velocity component
immediately following them, and serve to bias the differencing of
the convective terms, upwind biasing for the predictor step and downwind biasing for the corrector step, resulting in a second-order scheme
which is consistent with the scheme used for the continuity equation.
\be
\epsilon_u = \frac{u \, \dt}{\dx} \quad ; \quad \epsilon_v = \frac{v \, \dt}{\dy} \quad ; \quad \epsilon_w = \frac{w \, \dt}{\dz}
\ee
The subscript $i+\ha$ indicates that a variable is an average of its
values at the $i$th and the $(i+1)$th cell.
By construction, the divergence defined in Eq.~(\ref{eqn_divfromeos})
is identically equal to the divergence defined by
\be (\nabla\!\cdot \bu)_{ijk} = \frac{u_{ijk}-u_{i-1,jk}}{\dx} +
                               \frac{v_{ijk}-v_{i,j-1,k}}{\dy} +
                               \frac{w_{ijk}-w_{ij,k-1}}{\dz}   \ee
The equivalence of the two definitions of the divergence is a result
of the form of the discretized equations, the time-stepping scheme, and
the direct solution of the Poisson equation for the pressure.



\section{Large Eddy Simulation (LES)}
\label{LES}

The most distinguishing feature of any CFD model is its treatment of turbulence.
Chapter 1 contains a brief history of turbulence modeling as it has been applied to the fire
problem. Of the three main techniques of simulating turbulence, FDS contains only Large Eddy
Simulation (LES) and Direct Numerical Simulation (DNS). There is no Reynolds-Averaged Navier-Stokes (RANS)
capability in FDS.

LES is a technique used to model the dissipative processes (viscosity,
thermal conductivity, material diffusivity) that occur at length scales smaller than those that
are explicitly resolved on the numerical grid. This means that the parameters $\mu$, $k$ and $D$ in the equations
above cannot be used directly in most practical simulations. They must be replaced by surrogate expressions
that ``model'' their impact on the approximate form of the governing equations.
This section contains a simple explanation of how these terms are modeled
in FDS. Note that this discussion is quite different than what it typically found in the
literature, thus the reader is encouraged to consider other explanations of the technique in the references that are
listed in a review article by Pope~\cite{Pope:2004}.

There is a small term in the energy equation
known as the {\em dissipation rate}, $\epsilon$,
the rate at which kinetic energy is converted to thermal energy by viscosity:
\begin{align}
\epsilon &\equiv \btau_{ij} \cdot \nabla \bu \quad =  \quad
   \mu \left( 2 \; \bS_{ij} \cdot \bS_{ij}
                  - \frac{2}{3} (\nabla\!\cdot \bu)^2 \right)  \nonumber \\
  &= \mu \left[ 2 \left(\dod{u}{x}\right)^2
 + 2 \left(\dod{v}{y}\right)^2 + 2 \left(\dod{w}{z}\right)^2 + \right. \nonumber \\
&  \left.
  \left(\dod{v}{x}+\dod{u}{y}\right)^2 + \left(\dod{w}{y}+\dod{v}{z}\right)^2
 + \left(\dod{u}{z}+\dod{w}{x}\right)^2 - \frac{2}{3}
   \left(\dod{u}{x}+\dod{v}{y} + \dod{w}{z} \right)^2  \right]  \label{dissipation} \end{align}
This term is usually neglected in the energy conservation equation because it is very small relative to the heat release rate of
the fire. To understand where this term originates, form an evolution equation for the kinetic energy of the fluid by
taking the dot product of the momentum equation (\ref{momeq}) with the velocity vector\footnote{In this section
it is convenient to work with the Lagrangian form of the conservation equations. }:
\be \rho \, \frac{\mbox{D}\bu}{\mbox{D}t} \cdot \bu = \rho  \, \frac{\mbox{D}\left(|\bu|^2/2\right)}{\mbox{D}t} =
    \rho \bof_b \cdot \bu - \nabla p \cdot \bu + \nabla\!\cdot (\btau_{ij} \cdot \bu) - \epsilon \ee
As mentioned above $\epsilon$ is a negligible quantity in the energy equation. However, its functional form
is useful in representing the dissipation of kinetic energy from the resolved flow field.
Following the analysis of Smagorinsky~\cite{Smagorinsky:1}, the viscosity $\mu$ is modeled
\be \mu_{\hbox{\tiny LES}} = \rho \, (C_s\, \Delta)^2 \,
   \left(2 \; \overline{\bS}_{ij} : \overline{\bS}_{ij} - \frac{2}{3} (\nabla\!\cdot \overline{\bu})^2 \right)^\ha \ee
where $C_s$ is an empirical constant and $\Delta$ is a length on the
order of the size of a grid cell.
The bar above the various quantities denotes that these are the resolved values, meaning
that they are computed from the numerical solution sampled on a coarse grid (relative to DNS).
The other diffusive parameters,
the thermal conductivity and material diffusivity, are related to the turbulent viscosity by
\be k_{\hbox{\tiny LES}} = \frac{\mu_{\hbox{\tiny LES}} \, c_p}{\PR_t}
\quad ; \quad
 (\rho D)_{l,\hbox{\tiny LES}} =\frac{\mu_{\hbox{\tiny LES}}}{\SC_t} \ee
The turbulent Prandtl number $\PR_t$ and the turbulent Schmidt number $\SC_t$ are assumed to be
constant for a given scenario.

The model for the viscosity, $\mu_{\hbox{\tiny LES}}$, serves two roles: first, it provides a stabilizing
effect in the numerical
algorithm, damping out numerical instabilities as they arise in the flow field, especially where vorticity is
generated. Second, it has the appropriate mathematical form to describe the dissipation of kinetic energy from the flow.
Note the similar mathematical form of $\mu_{\hbox{\tiny LES}}$ and
the dissipation rate, $\epsilon$, defined in Eq.~(\ref{dissipation}).
In the parlance of the turbulence community, the dissipation
rate is related to the turbulent kinetic energy (most often denoted by $k$) by the
relation $\epsilon \approx k^{3/2}/L$, where $L$ is a length scale.

There have been numerous refinements of the original Smagorinsky
model~\cite{Deardorff:1,Germano:1,Lilly:1},
but it is difficult to assess the improvements offered by these newer
schemes for fires. There are two reasons for this. First, the structure of the
fire plume is so dominated by the large-scale resolvable eddies that
even a constant eddy viscosity gives results comparable to
those obtained using the Smagorinsky model~\cite{Baum:4}. Second, the lack
of precision in most large-scale fire test data makes it difficult to
assess the relative accuracy of each model.
The Smagorinsky model with constant $C_s$ produces satisfactory results
for most large-scale applications where boundary layers are not
well-resolved (see Volume 3, {\em Experimental Validation}). In fact, experience to date using the simple form of LES described above
has shown that the best results are obtained when the Smagorinsky constant $C_s$ is set
as low as possible to maintain numerical stability. In other words, the most realistic
flow simulations are obtained when resolvable eddies are not ``damped'' by excessive
amounts of artificial viscosity.

In the discretized form of the momentum equation, the LES form of the dynamic viscosity
is defined at cell centers
\be \mu_{ijk} = \rho_{ijk} \, (C_s\, \Delta)^2 \, |S|   \ee
where $C_s$ is an empirical constant, $\Delta=(\dx\,\dy\,\dz)^\ot$, and
\be |S|^2 = 2\left(\dod{u}{x}\right)^2 + 2\left(\dod{v}{y}\right)^2+
  2\left( \dod{w}{z}\right)^2
       + \left( \dod{u}{y} + \dod{v}{x} \right)^2
       + \left( \dod{u}{z} + \dod{w}{x} \right)^2
       + \left( \dod{v}{z} + \dod{w}{y} \right)^2
       - \frac{2}{3} (\nabla\!\cdot \bu)^2  \ee
The quantity $|S|$ consists of second order spatial differences
averaged at cell centers. For example
\begin{eqnarray}
\dod{u}{x} &\approx& \frac{u_{ijk}-u_{i-1,jk}}{\dx_i} \\
\dod{u}{y} &\approx& \frac{1}{2} \left( \frac{u_{i,j+1,k}-u_{ijk}}{\dy_{j+\ha}} + \frac{u_{ijk}-u_{i,j-1,k}}{\dy_{j-\ha}} \right) \end{eqnarray}
The divergence is described in Section~\ref{div_discret}.

The thermal conductivity and material
diffusivity of the fluid are related to the viscosity by
\be k_{ijk} = \frac{c_{p,0} \, \mu_{ijk}}{\PR_t}  \quad ; \quad
   (\rho D)_{ijk} = \frac{\mu_{ijk}}{\SC_t}  \ee
where $\PR_t$ is the turbulent Prandtl number and $\SC_t$ is the turbulent Schmidt number, both
assumed constant. Note that the specific heat $c_{p,0}$ is that of the
dominant species of the mixture. Based on simulations of smoke plumes,
$C_s$ is 0.20, $\PR_t$ and $\SC_t$ are 0.5. There are no rigorous justifications
for these choices other than through comparison with
experimental data~\cite{Zhang:1}.


\section{Direct Numerical Simulation (DNS)}
\label{DNS}

There are some flow scenarios where it is possible to use the molecular properties
$\mu$, $k$ and $D$ directly. Usually, this means that the numerical grid cells are on the
order of 1~mm or less, and the simulation is regarded as a
Direct Numerical Simulation (DNS).
For a DNS, the viscosity, thermal conductivity
and material diffusivity are approximated from kinetic theory because the temperature
dependence of each is important in combustion scenarios.
The viscosity of the species $\alpha$ is given by
\be \mu_\alpha = \frac{26.69\times 10^{-7} (W_\alpha \, T)^\ha}{\sigma_\alpha^2 \, \Omega_v}
\quad \quad \frac{\hbox{kg}}{\hbox{m s}} \ee
where $\sigma_\alpha$ is the Lennard-Jones
hard-sphere diameter ($\AA$) and $\Omega_v$ is the
collision integral, an empirical function of the
temperature $T$. The thermal conductivity of species $\alpha$ is given by
\be k_\alpha = \frac{\mu_\alpha \, c_{p,\alpha}}{\PR}  \quad \quad \frac{\hbox{W}}{\hbox{m K}}  \ee
where the Prandtl number $\PR$ is 0.7.
The viscosity and thermal conductivity of a gas mixture are given by
\be \mu_{\hbox{\tiny DNS}} = \sum_\alpha \; Y_\alpha \; \mu_\alpha  \quad ; \quad
k_{\hbox{\tiny DNS}} = \sum_\alpha \; Y_\alpha \; k_\alpha  \ee
The binary diffusion coefficient of species $\alpha$
diffusing into species $\beta$ is given by
\be D_{\alpha \beta} = \frac{2.66\times 10^{-7} \, T^{3/2} }{W_{\alpha \beta}^\ha \, \sigma_{\alpha \beta}^2 \, \Omega_D }
\quad \quad \frac{\hbox{m$^2$}}{s} \ee
where $W_{\alpha \beta}=2(1/W_\alpha+1/W_\beta)^{-1}$, $\sigma_{\alpha \beta}=(\sigma_\alpha+\sigma_\beta)/2$, and
$\Omega_D$ is the diffusion collision integral, an empirical
function of the temperature, $T$~\cite{Poling:1}.
It is assumed that nitrogen is the dominant species in any combustion
scenario considered here, thus the diffusion coefficient in the
species mass conservation equations is that of the given species diffusing
into nitrogen
\be (\rho D)_{\alpha,\hbox{\tiny DNS}} = \rho \;  D_{\alpha, 0} \ee
where species 0 is nitrogen.




\section{Velocity Boundary Conditions}

\subsection{Smooth Walls}
\label{smooth_wall_model}

In finite-volume LES, when the momentum equation is integrated over a cell adjacent to the wall it turns out that the most difficult term to handle is the viscous stress, $\tau_w$, because the wall-normal gradient of the streamwise velocity component cannot be resolved; the SGS stress at the wall is identically zero.  We have, therefore, an entirely different situation than exists in the bulk flow at high Reynolds number where the viscous terms are negligible and the SGS stress is of critical importance.  The fidelity of the SGS model still influences the wall stress, however, since other components of the SGS tensor affect the value of the near-wall velocity and hence the resulting viscous stress determined by the wall model. FDS models $\tau_w$ with a logarithmic velocity profile \cite{Pope:2000} described below.

An important scaling quantity in the near-wall region is the friction velocity, defined as $u^* \equiv \sqrt{\tau_w/\rho}$.
From the friction velocity we can define the nondimensional streamwise velocity $u^+ \equiv u/u^*$ and nondimensional wall-normal distance $y^+ \equiv y/\delta_\nu$,
where $\delta_\nu = \nu/u^* = \mu/(\rho u^*)$ is the \emph{viscous length scale}. The law of the wall is then given by
\begin{align}
\label{eqn_visclayer} u^+ &= y^+                           && \mbox{for} \quad y^+ \le 5 \\
\label{eqn_loglaw}    u^+ &= \frac{1}{\kappa} \ln y^+ + B  && \mbox{for} \quad y^+ \ge 30
\end{align}
where $\kappa = 0.41$ is the von K\'arm\'an constant and $B=5.2$.  The region $5 < y^+ < 30$, where both viscous and inertial stresses are important, is referred to as the buffer layer.  In FDS, the buffer layer is approximated with a semi-log fit connecting the limits of the viscous and log regions.
\begin{align}
\label{eqn_buffer_layer}
u^+ &= (1/\kappa)_{\mbox{\tiny\emph{buffer}}} \ln y^+ + B_{\mbox{\tiny\emph{buffer}}}  && \mbox{for} \quad 5 < y^+ < 30
\end{align}
where $(1/\kappa)_{\mbox{\tiny\emph{buffer}}}=4.74$ and $B_{\mbox{\tiny\emph{buffer}}}=-2.63$.

For the purposes of adapting the log law model to FDS we suppose that the first off-wall velocity component represents the profile sampled at a distance $\delta y/2$ in the wall-normal direction---streamwise components of velocity are stored at the face center on a staggered grid.  The density and molecular viscosity are taken as the average of the neighboring cell values and are taken to be uniform on the cell face where the streamwise velocity component is stored.

\subsection{Rough Walls}
\label{rough_wall_model}

For rough walls FDS employs the log law presented in Pope \cite{Pope:2000},
\begin{equation}
\label{eqn_roughwallloglaw}
u^+ = \frac{1}{\kappa} \ln \left(\frac{y}{s}\right) + \tilde{B}(s^+)
\end{equation}
where $s^+ = s/\delta_\nu$ is the roughness length in viscous units and $s$ is the dimensional roughness (prescribed by setting {\tt ROUGHNESS} [in meters] on the {\tt SURF} line). The distance to the wall, $y$, is taken as $\delta y/2$ for the first off-wall grid cell.  The parameter $\tilde{B}$ varies with $s^+$ but attains a constant value $B_2=8.5$ in the fully rough limit.  In FDS, we implement $\tilde{B}$ as the following piece-wise function:
\begin{equation}
\tilde{B} = \left\{ \begin{array}{lll} B + (1/\kappa)\ln(s^+)  & \mbox{for} &          s^+ < 5.83 \\
                                       \tilde{B}_{max}         & \mbox{for} & 5.83 \le s^+ < 30.0 \\
                                       B_2                     & \mbox{for} &          s^+ \ge 30.0 \end{array} \right.
\end{equation}
where $\tilde{B}_{max} = 9.5$.

\subsection{Wall Model Implementation}
Once $u^+$ has been determined from the model profile, the stress may be obtained from (the definition of $u^+$)
\begin{equation}
\label{eqn_wall_stress}
\tau_w = \rho \left( \frac{u}{u^+} \right)^2
\end{equation}
Generally, this requires an iterative procedure since $\tau_w$ is needed to define $\delta_\nu$ and hence $y^+$.  The strategy employed in FDS is to first compute $\tau_w$ as if the flow is locally laminar (DNS), and if the calculation is an LES the laminar value is used as an initial guess.  Testing has shown that three iterations is sufficient to converge the residual error in the profile model to 1 \%.


\section{Time Step and Stability Constraints}

\label{stability}

In explicit schemes, stability criteria may often be understood in terms of using the time step to maintain physically realizable conditions.  Below we examine the necessary conditions for stability in the presence of advection, diffusion, and expansion of the velocity and scalar fields.

\subsection{The Courant-Friedrichs-Lewy (CFL) Constraint}

The well-known CFL constraint given by
\begin{equation}
\mbox{CFL} = \delta t \frac{\|\mathbf{u}\|}{\delta x} \approx 1
\end{equation}
places a restriction on the time step due to the advection velocity. Physically, the constraint says that a fluid element should not traverse more than one cell within a time step. For LES, this constraint has the added advantage of keeping the implicit temporal and spatial filters consistent with each other.  In other words, in order to resolve an eddy of size $\delta x$, the time step needs to be in concert with the CFL.  If one were to employ an implicit scheme for purpose of taking time steps say 10 times larger than the CFL limit, the smallest resolvable turbulent motions would then be roughly 10 times the grid spacing, which would severely limit the benefit of the LES.  In most cases, if one wishes the simulation to run faster, a better strategy is to coarsen the grid resolution while keeping the CFL $\approx 1$.

The exact CFL needed to maintain stability depends on the order (as well as other properties) of the time integration scheme and the choice of velocity norm. Three choices for velocity norm are available in FDS (set on {\ct MISC}):
\vskip\baselineskip
\noindent
{\ct CFL\_VELOCITY\_NORM=0} (default, least restrictive, corresponds to $L_\infty$ norm of velocity vector)
    \begin{equation}
    \frac{\|\mathbf{u}\|}{\delta x} = \max \left(\frac{|u|}{\delta x}, \frac{|v|}{\delta y}, \frac{|w|}{\delta z}\right)
    \end{equation}
{\ct CFL\_VELOCITY\_NORM=1} (most restrictive, corresponds to $L_1$ norm of velocity vector)
    \begin{equation}
    \frac{\|\mathbf{u}\|}{\delta x} = \frac{|u|}{\delta x}+\frac{|v|}{\delta y}+\frac{|w|}{\delta z}
    \end{equation}
{\ct CFL\_VELOCITY\_NORM=2} ($L_2$ norm of velocity vector)
    \begin{equation}
    \frac{\|\mathbf{u}\|}{\delta x} = \sqrt{ (u/\delta x)^2+(v/\delta y)^2+(w/\delta z)^2 }
    \end{equation}

\subsection{The Von Neumann Constraint}

The Von Neumann constraint is given by
\begin{equation}
\mbox{VN} = \delta t \max[(\mu/\rho),D_\alpha] \sum_i \frac{1}{\delta x_i^2} < \frac{1}{2}
\end{equation}
We can understand this constraint in a couple of different ways.  First, we could consider the model for the diffusion velocity of species $\alpha$ in direction $i$, $V_{\alpha,i} = -D_\alpha \partial Y_\alpha/\partial x_i$, and we would then see that VN is simply a CFL constraint due to diffusive transport.

We can also think of VN in terms of a total variation diminishing (TVD) constraint.  That is, if we have variation (curvature) in the scalar field, we do not want to create spurious wiggles that can lead to an instability by overshooting the smoothing step.  Consider the following explicit update of the heat equation for $u$ in 1D. Here subscripts indicate grid indices and $\nu$ is the diffusivity.
\begin{equation}
u_i^{n+1} = u_i^n + \frac{\delta t \nu}{\delta x^2} (u_{i-1}^n - 2u_i^n + u_{i+1}^n )
\end{equation}
Very simply, notice that if $\delta t \nu/\delta x^2 = 1/2$ then $u_i^{n+1} = (u_{i-1}^n + u_{i+1}^n)/2$.  If the time step is any larger we overshoot the straight line connecting neighboring cell values.  Of course, this restriction is only guaranteed to be TVD if the $u$ field is ``smooth'', else the neighboring cell values may be shifting in the opposite direction.  Unfortunately, in LES there is no such guarantee and so the VN constraint can be particularly devilish in generating instabilities. For this reason, some practitioners like to employ implicit methods for the diffusive terms.

\subsection{Realizable Mass Density Constraint}

In an explicit Euler update of the continuity equation, if the time increment is too large the computational cell may be totally drained of mass, which of course is not physical. The constraint $\rho^{n+1}>0$ therefore leads to the following restriction on the time step:
\begin{equation}
\label{eqn_dtmassrestrict}
\delta t < \frac{\rho^n}{\overline{\mathbf{u}}^n\cdot\nabla\rho^n + \rho^n \nabla\cdot\mathbf{u}^n}
\end{equation}
We can argue that the case we are most concerned with is when $\rho^n$ is near zero.  A reasonable approximation to (\ref{eqn_dtmassrestrict}) then becomes (time location suppressed, summation over $i$ is implied)
\begin{eqnarray}
\label{eqn_divstability}
\delta t &<& \frac{\rho}{\overline{u}_i \left(\frac{\rho-0}{\delta x_i}\right) + \rho \nabla\cdot\mathbf{u}} \nonumber\\
&<& \left[ \frac{\overline{u}_i}{\delta x_i} + \nabla\cdot\mathbf{u} \right]^{-1}
\end{eqnarray}
Equation (\ref{eqn_divstability}) basically adds the effect of thermal expansion to the CFL constraint and provides a reason to prefer {\ct CFL\_VELOCITY\_NORM=1} as the basis for the time step restriction.

\subsection{Heat Transfer Constraint}

Note that the heat transfer coefficient, $h$, has units of W/(m$^2$\,K).  Thus, a velocity scale may be formed from $h/(\rho\, c_p)$.  Anytime we have a velocity scale to resolve we have a CFL-type stability restriction.  Therefore, the heat transfer stability check loops over all wall cells to ensure $\delta t \le \delta x \,\rho \,c_p/h$.  This check may be skipped by setting {\ct CHECK\_HT=.FALSE.} on {\ct MISC}.

\subsection{Gravitational Constraint}

A time scale restriction based on gravitational acceleration can be formed from $\delta t \le \sqrt{\delta z/g}$.  This check may be omitted by setting  {\ct CHECK\_GR=.FALSE.} on {\ct MISC}.

\subsection{Adjusting the Time Step} In the call to {\ct CHECK\_STABILITY} both the CFL and VN numbers are compared with {\ct CFL\_MAX [1.0]}, {\ct CFL\_MIN [0.8]}, {\ct VN\_MAX [0.5]}, and {\ct VN\_MIN [0.4]}, respectively (default values shown in brackets).  To be clear, the CFL constraint is now given by
\begin{equation}
\mbox{CFL} = \delta t \left( \frac{\|\mathbf{u}\|}{\delta x} + |\nabla\cdot\mathbf{u}| \right)
\end{equation}
If either the current CFL or VN is too large then the new time step is set to 90\% of the allowable value.  If both CFL and VN are below their minimum values then the current time step is increased by 10\%.  The initial time step may be set and locked on the {\tt TIME} line of the FDS input file.  See the User's Guide for details.


\clearpage
\section{The Equation for Pressure (Poisson Equation)}

An elliptic partial differential equation (known as a Poisson equation) is obtained by
taking the divergence of the momentum equation
\be \nabla^2 {\cal H} =
     -\dod{(\nabla\!\cdot \bu)}{t} - \nabla\!\cdot \bF
    \quad ; \quad \bF = - \bu\times\bo - \tp \nabla \left( \frac{1}{\rho} \right) - \frac{1}{\rho}
    \Big( (\rho-\rho_0) \bg + \bof_b + \nabla\!\cdot \btau_{ij} \Big)
   \label{pe}\ee
Note that the pressure $\tp$ appears on both sides of Eq.~(\ref{pe}). The
pressure on the right hand side is taken from the previous time step of the
overall explicit time-marching scheme. It can be neglected if the baroclinic torque is
not considered important in a given simulation. The pressure on the left hand side (incorporated
in the variable $\cal H$) is solved for directly.
The reason for the decomposition of the pressure term is so that the linear algebraic system
arising from the discretization of Eq.~(\ref{pe})
has constant coefficients ({\em i.e.} it is {\em separable}) and can be solved to machine accuracy
by a fast, direct ({\em i.e.} non-iterative) method that utilizes
Fast Fourier Transforms (FFT).

The discretized form of the
Poisson equation for the modified pressure, $\hp$, is:
\begin{eqnarray}
\frac{\hp_{i+1,jk}-2\hp_{ijk}+\hp_{i-1,jk}}{\dx^2} +
\frac{\hp_{i,j+1,k}-2\hp_{ijk}+\hp_{i,j-1,k}}{\dy^2} +
\frac{\hp_{ij,k+1}-2\hp_{ijk}+\hp_{ij,k-1}}{\dz^2} \nonumber \\ =
    -\frac{F_{\x,ijk} - F_{\x,i-1,jk}}{\dx}
    -\frac{F_{\y,ijk} - F_{\y,i,j-1,k}}{\dy}
    -\frac{F_{\z,ijk} - F_{\z,ij,k-1}}{\dz} - \dod{ }{t}(\nabla\!\cdot \bu)_{ijk}
\end{eqnarray}
The lack of a superscript implies that all quantities are to be
evaluated at the same time level.
This elliptic partial differential equation is solved using a direct
(non-iterative) FFT-based solver~\cite{Sweet:1} that is part of a library of routines
for solving elliptic PDEs called CRAYFISHPAK\footnote{CRAYFISHPAK, a vectorized form of the
elliptic equation solver FISHPAK, was originally developed at the National Center for Atmospheric
Research (NCAR) in Boulder, Colorado.}.
To ensure that the divergence of the fluid is consistent with the definition
given in Eq.~(\ref{eqn_divfromeos}), the time derivative of the divergence is defined
\be \dod{ }{t}(\nabla\!\cdot \bu)_{ijk} \equiv
          \frac{(\nabla\!\cdot \bu)_{ijk}^*
              - (\nabla\!\cdot \bu)_{ijk}^n}{\dt} \ee
at the predictor step, and then
\be \dod{ }{t}(\nabla\!\cdot \bu)_{ijk} \equiv
         \frac{(\nabla\!\cdot \bu)_{ijk}^{n+1} -
         \ha \left[ (\nabla\!\cdot \bu)_{ijk}^*
       + (\nabla\!\cdot \bu)_{ijk}^n \right]}{\dt/2} \ee
at the corrector step. The discretization of the divergence is
given in Eq.~(\ref{eqn_divfromeos}).


\subsection{Open Boundary Conditions}

Outflow: The outflow condition is quite simple.
Let $q \equiv |\mathbf{u}|$. By definition, ${\cal H} = \frac{1}{2}q^2 + \tilde{p}/\rho$.
The pressure $\tilde{p}$ is set to $\tilde{p}_{ext}$ by the user ({\ct DYNAMIC\_PRESSURE}, 0 by default).
\\
\\
Inflow: When fluid is entering the domain at an {\tt OPEN} vent we make the assumption that
Bernoulli holds (i.e. inviscid, steady, incompressible) and that the fluid element on the boundary has
accelerated from the state \{$\tilde{p}_1,\rho_1,q_1$\} along a streamline:
\begin{equation}
\tilde{p}_1 + \mbox{$\frac{1}{2}$}\rho_1 q_1^2 = \tilde{p}_2 + \mbox{$\frac{1}{2}$}\rho_2 q_2^2
\end{equation}
Let's say the fluid has kinetic energy $\frac{1}{2}\rho_1 q_1^2$ at point 1 with
ambient pressure $\tilde{p}_1 = \tilde{p}_{ext}$ and accelerates to $q_2$ at point 2 which is on an inflow boundary.
Substituting the definition of ${\cal H}$ for point 2 we obtain
\begin{equation}
\tilde{p}_{ext} + \mbox{$\frac{1}{2}$}\rho_1 q_1^2 = \rho_2({\cal H}_2 - \mbox{$\frac{1}{2}$} q_2^2) +
\mbox{$\frac{1}{2}$} \rho_2 q_2^2
\end{equation}
which rearranges to
\begin{equation}
{\cal H}_2 = \frac{\tilde{p}_{ext}}{\rho_2} + \underbrace{\frac{1}{2}q_1^2 \frac{\rho_1}{\rho_2}}_{{\cal H}_0}
\end{equation}
The density $\rho_2$ is taken as the average density between the gas-phase and ghost cells adjacent to the boundary. In practice, the second term is specified by the user, ${\cal H}_0 = \frac{1}{2}(u_0^2 + v_0^2 + w_0^2)$, by setting the initial velocity components on the {\tt MISC} line.  It is assumed that the initial velocity also applies outside the domain at point 1 along the streamline.



\subsection{Solid Boundary Conditions}

Direct Poisson solvers are most efficient if the domain is a
rectangular region, although other geometries such as cylinders
and spheres can be handled almost as easily. For these solvers,
a no-flux condition is simple to prescribe at external boundaries.
Using the $x=x_{\hbox{\tiny max}}$ boundary as an example:
\be \dod{{\cal H}}{x} = -F_x - \dod{u}{t} \label{bc} \ee
where $F_x$ is the $x$-component of $\bF$ at the vent or solid wall,
and $\partial u/\partial t$ is the user-specified rate of change
in the $x$-component of velocity.
In discretized form, the Poisson solver is
supplied with the Neumann boundary condition
\be \frac{\hp_{I+1,jk}-\hp_{I,jk}}{\dx} = -F_{x,I,jk} \label{dbc} \ee
because the normal component of velocity is zero at this boundary from the start of the calculation.
However, many practical problems involve more
complicated geometries. For building fires,
doors and windows within multi-room enclosures are very important features
of the simulations. These elements may be included
in the overall domain as masked grid cells,
but the no-flux condition (\ref{dbc}) cannot be directly prescribed
at the boundaries of these blocked cells.
Fortunately, it is possible to exploit
the relatively small changes in the pressure from one time
step to the next to enforce the no-flux condition.
At the start of a time step,
the components of the convection/diffusion term $\bF$ are computed
at all cell faces that do not correspond to walls.
At those cell faces that do correspond to solid walls but are not located at the exterior of the
computational grid, we prescribe (using the same example as above, but now with $i \ne I$):
\be
F_{x,ijk}^n = - \frac{\hp_{i+1,jk}^{n-1}-\hp_{ijk}^{n-1}}{\dx} - \frac{u_{ijk}^*-u_{ijk}^n}{\dt} \label{sbc}
\ee
at the predictor step, and
\be
F_{x,ijk}^* = - \frac{\hp_{i+1,jk}^{*-1}-\hp_{ijk}^{*-1}}{\dx} - \frac{u_{ijk}^{n+1}-\ha
   \left( u_{ijk}^*+u_{ijk}^n \right)}{\dt/2} \label{sbcc}
\ee
at the corrector step. Note that $*-1$ denotes the pressure term used in the corrector part of the
previous time step.
In both of these cases, the value of $\hp^n$ or $\hp^*$ is not known. That is what we are solving for.
Instead, the value of $\hp$ from the previous time step is used to estimate the pressure gradient.
Equations~(\ref{sbc}) or (\ref{sbcc}) assert that following the solution of the Poisson
equation for the pressure, the desired normal component of velocity at the next time step, $u^*$ or $u^{n+1}$, will
be driven towards zero.
This is approximate because the true value of the velocity time
derivative depends on the solution of the pressure equation, but since
the most recent estimate of pressure is used, the approximation is fairly
good. Also, even though there are small errors in normal velocity at solid
surfaces, the divergence of each blocked cell
remains exactly zero for the duration of the calculation.
In other words, the total flux into a given obstruction is always identically
zero, and the error in normal velocity is usually at least
several orders of magnitude smaller than the characteristic flow velocity.
When implemented as part of a predictor-corrector updating scheme,
the no-flux condition at solid surfaces is maintained fairly well. If greater accuracy is
required, the Poisson equation can be solved iteratively as the boundary condition (\ref{sbc}) or (\ref{sbcc}) is updated with
each successive approximation of the pressure gradient at the solid wall.



\subsection{Boundary Conditions at Mesh Interfaces}
\label{app_pressure_correction}

The time advancement scheme for multiple meshes involves averaging the normal components of velocity at the mesh interface in
order to drive them closer into alignment. Because FDS uses a staggered grid, the normal components of velocity co-exist on the mesh interface.
Consider two meshes joined side by side in the $x$ direction. The component $u_I \equiv u_{I,jk}$ lives on the right boundary of the left hand mesh, and
$u_0 \equiv u_{0,jk}$ lives on the left boundary of the right hand mesh.
Ideally, these velocities should be identical, but they are not because of errors associated with solving the pressure on each mesh separately.
While the primitive velocity components are indeed unique to a given mesh, for each mesh we may define the
discrete ``patch-averaged'' field $\bar{\mathbf{u}}$ which is identical at all overlapping mesh points.
To do this we simply average the coincident values of the normal velocity component at the mesh interfaces.
For instance, considering the same side-by-side meshes as before,
\be
\label{eqn_patchave_ufield}
\bar{u}_I = \bar{u}_0 \equiv \frac{1}{2} \left( u_{I,jk} + u_{0,jk} \right)
\ee
for all patch boundary cells $j$ and $k$. Here, for simplicity, we are only considering the case in which the
cell sizes are equivalent for the adjoining meshes (coarse-fine mesh interfaces are currently handled by the code,
but details will be documented at a later date).

To see how the new patch-averaged fields are used, consider the predictor step in the time advancement,
which may now be written as
\begin{equation}
\label{eqn_RK1}
\mathbf{u}^* = \bar{\mathbf{u}}^n - \dt \left( \mathbf{F}(\bar{\mathbf{u}}^n) + {\nabla\cH}^n \right)
\end{equation}
Note that (\ref{eqn_RK1}) updates a $\bar{\mathbf{u}}$ field to a $\mathbf{u}$ field. In other words, the normal components
of velocity at the interface are no longer expected to match because the individual pressure fields do not match exactly
at the interface. However, the error introduced in the divergence by the velocity averaging procedure is corrected by the time
derivative of divergence in the pressure equation:
\be
\label{eqn_poisson_stg1}
\nabla^2 {\cH}^n = -\left(\frac{ \nabla\!\cdot \bu^* - \nabla\!\cdot \bu^n - \nabla\!\cdot (\bar{\bu}^n - \bu^n) }{\delta t}\right) -
  \mathbf{F}(\bar{\mathbf{u}}^n)
\ee
The extra term in the time derivative, $\nabla\!\cdot (\bar{\bu}^n - \bu^n)$, ``corrects'' the divergence error.
The benefit to averaging the normal components of velocity at mesh interfaces is that $\mathbf{F}$ is the same on each side of the interface,
since all force terms are determined using the patch-averaged field.
This also means that stress tensors computed at a mesh interface (which are buried in $\mathbf{F}$) are symmetric;
this symmetry is a requirement for angular momentum conservation.  Thus, the patch-averaging procedure prevents the
production of spurious vorticity at mesh interfaces.

Equation~(\ref{eqn_poisson_stg1}) corrects the error in the divergence resulting from the averaging of normal velocity components, but it still does not guarantee that the
updated velocity components will be equal. To drive the two normal components of velocity closer together, we use the
following iterative scheme in the predictor step, again using the $x$ direction interface boundary as an example:
\begin{enumerate}
\item Define the pressure term at the mesh interface, $\cH_B$, consistent with a Dirichlet boundary condition. Note that the superscript ``old'' refers to the fact that at this point, the Poisson equation for pressure has not been solved:
\be
   \cH_B = \frac{\cH_I^{old} + \cH_1^{old} }{2} + \frac{\dx}{4\, \dt} \left( u_I^{*,\,old}-u_0^{*,\,old} \right)
\ee
Note also that $\cH$ is cell-centered; thus, $\cH_I$ is at the center of the $I$th grid cell of the left hand mesh, and $\cH_1$ is at the center of the first grid cell of the right hand mesh.
\item Solve the Poisson equation in each mesh separately and exchange values of $\cH_I$ and $\cH_1$.
\item Predict the normal component of velocity at the next time step. Note that the boundary condition for interface pressure term effectively yields the following:
\begin{eqnarray}
   u_I^* &=& \bar{u}_I^n - \frac{u_I^{*,\, old}-u_0^{*,\, old}}{2} - \dt \left( F_{x,I}^{n} + \frac{ (\cH_I^{old}+\cH_1^{old})/2 - H_I }{ \dx/2} \right) \label{uI} \\
   u_0^* &=& \bar{u}_0^n + \frac{u_I^{*,\, old}-u_0^{*,\, old}}{2} - \dt \left( F_{x,0}^{n} + \frac{ H_1 - (\cH_I^{old}+\cH_1^{old})/2 }{ \dx/2} \right) \label{u0}
\end{eqnarray}
\item Repeat this process until $\left| u_I^* - u_0^* \right|$ falls below a specified tolerance.
\end{enumerate}
For the corrector step, the procedure is the same, except the boundary condition for the pressure term is:
\be
   \cH_B = \frac{\cH_I^{old} + \cH_1^{old} }{2} + \frac{\dx}{2\, \dt} \left( u_I^{n+1,\,old}-u_0^{n+1,\,old} \right)
\ee

