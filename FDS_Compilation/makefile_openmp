# Makefile for Fire Dynamics Simulator (FDS), Version 5

# To use this makefile, select the appropriate compiler and OS from the list below. For example, to
# compile the 64 bit parallel version (MPI) of FDS under Linux with OpenMP using the Intel compilers type:
#
# make openmp_mpi_intel_linux_64

# The variable VPATH defines where the source code is relative to the current directory

VPATH = ../FDS_Source

# Definition of the Serial or MPI object variables (same, except for main vs main_mpi)

obj_serial = isob.o prec.o smvv.o cons.o devc.o type.o mesh.o func.o irad.o \
             ieva.o pois.o radi.o evac.o part.o vege.o ctrl.o dump.o read.o turb.o mass.o \
             wall.o fire.o pres.o divg.o init.o velo.o main.o
objwin_serial = $(obj_serial:.o=.obj)

obj_mpi = isob.o prec.o smvv.o cons.o devc.o type.o mesh.o func.o irad.o \
          ieva.o pois.o radi.o evac.o part.o vege.o ctrl.o dump.o read.o turb.o mass.o \
          wall.o fire.o pres.o divg.o init.o velo.o main_mpi.o
objwin_mpi = $(obj_mpi:.o=.obj)

# General Purpose Rules

no_target:
	@echo \******** You did not specify a make target \********
	@echo Please read the comments at the top of the makefile

setup:
%.o : %.mod

setup_win:
%.obj : %.mod

.SUFFIXES: .c .f90 .o .obj

# Files which have OpenMP compiler directives have to be compiled
# by using the FOPENMPFLAG
# read.f90 has to be compiled without optimization, otherwise 
# errors occure when reading .fds files.

func.o: FFLAGS += $(FOPENMPFLAGS)
part.o: FFLAGS += $(FOPENMPFLAGS)
turb.o: FFLAGS += $(FOPENMPFLAGS)
mass.o: FFLAGS += $(FOPENMPFLAGS)
fire.o: FFLAGS += $(FOPENMPFLAGS)
divg.o: FFLAGS += $(FOPENMPFLAGS)
velo.o: FFLAGS += $(FOPENMPFLAGS)
read.o: FOPTIMIZATIONFLAGS = -O0

func.obj: FFLAGS += $(FOPENMPFLAGS)
part.obj: FFLAGS += $(FOPENMPFLAGS)
turb.obj: FFLAGS += $(FOPENMPFLAGS)
mass.obj: FFLAGS += $(FOPENMPFLAGS)
fire.obj: FFLAGS += $(FOPENMPFLAGS)
divg.obj: FFLAGS += $(FOPENMPFLAGS)
velo.obj: FFLAGS += $(FOPENMPFLAGS)
read.obj: FOPTIMIZATIONFLAGS = -Od

.f90.o:
	$(FCOMPL) -c $(FOPTIMIZATIONFLAGS) $(FFLAGS) $<
.f90.obj:
	$(FCOMPL) -c $(FOPTIMIZATIONFLAGS) $(FFLAGS) $<
.c.o:
	$(CCOMPL) -c $(CFLAGS) $<
.c.obj:
	$(CCOMPL) -c $(CFLAGS) $<

#*** Compiler Specific Rules ***

# Windows Intel Compiler, version 11

 #*** note: the following scripts (located in ..\Scripts directory) must be run before running make with this target
 #    ..\Scripts\iclvars ia32
 #    ..\Scripts\ifortvars ia32

openmp_intel_win_32 : FFLAGS = /Qvec_report0
openmp_intel_win_32 : CFLAGS = -O2 -Dpp_noappend
openmp_intel_win_32 : FCOMPL = ifort
openmp_intel_win_32 : CCOMPL = icl
openmp_intel_win_32 : FOPENMPFLAGS = /Qopenmp /Qopenmp-link:static
openmp_intel_win_32 : FOPTIMIZATIONFLAGS = -O2
openmp_intel_win_32 : obj = fds5_openmp
openmp_intel_win_32 : setup_win $(objwin_serial)
	$(FCOMPL) -o $(obj) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) /F100000000 $(objwin_serial)

openmp_mpi_intel_win_32 : MPILIB = "c:\program files\mpich2\lib\fmpich2.lib"
openmp_mpi_intel_win_32 : MPIINCLUDE = "c:\program files\mpich2\include"
openmp_mpi_intel_win_32 : FFLAGS = /Qvec_report0 /I $(MPIINCLUDE) 
openmp_mpi_intel_win_32 : CFLAGS = -O2 -Dpp_noappend
openmp_mpi_intel_win_32 : FOPENMPFLAGS = /Qopenmp /Qopenmp-link:static
openmp_mpi_intel_win_32 : FOPTIMIZATIONFLAGS = -O2
openmp_mpi_intel_win_32 : FCOMPL = ifort
openmp_mpi_intel_win_32 : CCOMPL = icl
openmp_mpi_intel_win_32 : obj = fds5_openmp_mpi
openmp_mpi_intel_win_32 : setup_win $(objwin_mpi)
	$(FCOMPL) -o $(obj) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) /F100000000 $(objwin_mpi) $(MPILIB)

# Intel Compiler for Linux, version 11

openmp_intel_linux_32 : FFLAGS = -m32 -static -vec_report0
openmp_intel_linux_32 : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_intel_linux_32 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_32 : FOPTIMIZATIONFLAGS = -O3
openmp_intel_linux_32 : FCOMPL = ifort
openmp_intel_linux_32 : CCOMPL = icc
openmp_intel_linux_32 : obj = fds5_openmp_intel_linux_32
openmp_intel_linux_32 : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_intel_linux_32_db : FFLAGS = -m32 -static -vec_report0 -check -warn unused -auto -WB -traceback -g -fltconsistency -fp-model:strict
openmp_intel_linux_32_db : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_intel_linux_32_db : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_32_db : FOPTIMIZATIONFLAGS = -O0
openmp_intel_linux_32_db : FCOMPL = ifort
openmp_intel_linux_32_db : CCOMPL = icc
openmp_intel_linux_32_db : obj = fds5_openmp_intel_linux_32_db
openmp_intel_linux_32_db : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_mpi_intel_linux_32 : FFLAGS = -m32 -vec_report0
openmp_mpi_intel_linux_32 : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_mpi_intel_linux_32 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_mpi_intel_linux_32 : FOPTIMIZATIONFLAGS = -O3
openmp_mpi_intel_linux_32 : FCOMPL = mpif90 -fc=ifort
openmp_mpi_intel_linux_32 : CCOMPL = icc
openmp_mpi_intel_linux_32 : obj = fds5_openmp_mpi_intel_linux_32
openmp_mpi_intel_linux_32 : setup $(obj_mpi)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi)

openmp_intel_linux_64 : FFLAGS = -m64 -static -vec_report0
openmp_intel_linux_64 : CFLAGS = -m64 -O -Dpp_noappend -vec_report0
openmp_intel_linux_64 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_64 : FOPTIMIZATIONFLAGS = -O3
openmp_intel_linux_64 : FCOMPL = ifort
openmp_intel_linux_64 : CCOMPL = icc
openmp_intel_linux_64 : obj = fds5_openmp_intel_linux_64
openmp_intel_linux_64 : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_intel_linux_64_db : FFLAGS = -m64 -static -vec_report0 -check -warn unused -auto -WB -traceback -g -fltconsistency -fp-model:strict
openmp_intel_linux_64_db : CFLAGS = -m64 -O -Dpp_noappend -vec_report0
openmp_intel_linux_64_db : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_64_db : FOPTIMIZATIONFLAGS = -O0
openmp_intel_linux_64_db : FCOMPL = ifort
openmp_intel_linux_64_db : CCOMPL = icc
openmp_intel_linux_64_db : obj = fds5_openmp_intel_linux_64_db
openmp_intel_linux_64_db : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_mpi_intel_linux_64 : FFLAGS = -m64 -vec_report0
openmp_mpi_intel_linux_64 : CFLAGS = -m64 -O -Dpp_noappend -vec_report0
openmp_mpi_intel_linux_64 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_mpi_intel_linux_64 : FOPTIMIZATIONFLAGS = -O3
openmp_mpi_intel_linux_64 : FCOMPL = mpif90 -fc=ifort
openmp_mpi_intel_linux_64 : CCOMPL = icc
openmp_mpi_intel_linux_64 : obj = fds5_openmp_mpi_intel_linux_64
openmp_mpi_intel_linux_64 : setup $(obj_mpi)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi)

#*** End Compiler Specific Rules ***

# *** Object Dependencies ***

isob.o : isob.c
smvv.o : smvv.f90 isob.c
prec.o : prec.f90
cons.o : cons.f90 prec.f90
type.o : type.f90 prec.f90 cons.f90
devc.o : devc.f90 prec.f90
pois.o : pois.f90 prec.f90
mesh.o : mesh.f90 prec.f90 type.f90
func.o : func.f90 prec.f90 cons.f90 type.f90 mesh.f90
turb.o : turb.f90 func.f90 prec.f90 cons.f90 mesh.f90
ctrl.o : ctrl.f90 prec.f90 cons.f90 type.f90 mesh.f90 func.f90
irad.o : irad.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
ieva.o : ieva.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
fire.o : fire.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
wall.o : wall.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
velo.o : velo.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 turb.f90
divg.o : divg.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
mass.o : mass.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 turb.f90
radi.o : radi.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 irad.f90
evac.o : evac.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 ieva.f90
pres.o : pres.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 pois.f90
part.o : part.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90
vege.o : vege.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90
read.o : read.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 irad.f90 evac.f90
init.o : init.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 irad.f90 pois.f90
dump.o : dump.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 evac.f90 smvv.f90 isob.c 
main.o : main.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 smvv.f90 isob.c mass.f90 divg.f90 velo.f90 wall.f90 fire.f90 irad.f90 ieva.f90 radi.f90 evac.f90 part.f90 vege.f90 dump.f90 read.f90 init.f90 pres.f90 pois.f90 ctrl.f90 turb.f90
main_mpi.o : main_mpi.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 smvv.f90 isob.c mass.f90 divg.f90 velo.f90 wall.f90 fire.f90 irad.f90 ieva.f90 radi.f90 evac.f90 part.f90 vege.f90 dump.f90 read.f90 init.f90 pres.f90 pois.f90 ctrl.f90 turb.f90

isob.obj : isob.c
smvv.obj : smvv.f90 isob.c
prec.obj : prec.f90
cons.obj : cons.f90 prec.f90
type.obj : type.f90 prec.f90 cons.f90
devc.obj : devc.f90 prec.f90
pois.obj : pois.f90 prec.f90
mesh.obj : mesh.f90 prec.f90 type.f90
func.obj : func.f90 prec.f90 cons.f90 type.f90 mesh.f90
turb.obj : turb.f90 func.f90 prec.f90 cons.f90 mesh.f90
ctrl.obj : ctrl.f90 prec.f90 cons.f90 type.f90 mesh.f90 func.f90
irad.obj : irad.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
ieva.obj : ieva.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
fire.obj : fire.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
wall.obj : wall.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
velo.obj : velo.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 turb.f90
divg.obj : divg.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90
mass.obj : mass.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 turb.f90
radi.obj : radi.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 irad.f90
evac.obj : evac.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 ieva.f90
pres.obj : pres.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 pois.f90
part.obj : part.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90
vege.obj : vege.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90
read.obj : read.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 irad.f90 evac.f90
init.obj : init.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 irad.f90 pois.f90
dump.obj : dump.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 evac.f90 smvv.f90 isob.c 
main.obj : main.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 smvv.f90 isob.c mass.f90 divg.f90 velo.f90 wall.f90 fire.f90 irad.f90 ieva.f90 radi.f90 evac.f90 part.f90 vege.f90 dump.f90 read.f90 init.f90 pres.f90 pois.f90 ctrl.f90 turb.f90
main_mpi.obj : main_mpi.f90 func.f90 prec.f90 cons.f90 type.f90 mesh.f90 devc.f90 smvv.f90 isob.c mass.f90 divg.f90 velo.f90 wall.f90 fire.f90 irad.f90 ieva.f90 radi.f90 evac.f90 part.f90 vege.f90 dump.f90 read.f90 init.f90 pres.f90 pois.f90 ctrl.f90 turb.f90


#*** Clean Target to remove Object and Module files ***

.PHONY : clean
clean:
	-rm -f *.o *.mod *.obj 

.PHONY : winclean
winclean:
	-erase *.mod *.obj 