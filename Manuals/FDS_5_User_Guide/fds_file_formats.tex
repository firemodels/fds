
% --------------------DATA FILE FORMATS -----------------------

\section{Data File Formats (.s3d, .iso, .part, .sf, .bf, .q and CAD/.ge1 files)}
\label{sectionfile} \Smokeview\ visualizes Fire Dynamics
Simulator data using isosurface, particle, boundary, slice
and Plot3D data files.  Realistic geometric data created by DX2FDS is represented in a
CAD or .ge1 file.  This section documents the data format of
each FDS data file by showing FORTRAN program code segments
used to write the data out.  All FDS files are unformatted and
are opened using {\tt OPEN} statements of the form:
\begin{verbatim}
OPEN(UNIT=IUNIT,FILE=FILENAME,FORM="UNFORMATTED")
\end{verbatim}
where {\tt IUNIT} is the FORTRAN unit number used for output and {\tt FILENAME}
is a character variable containing the file name.  The CAD/.ge1 file is an ascii text file.
In the following code segments the standard FORTRAN naming convention of associating
variables beginning with I through N to integer variables and all other alphabetic
characters to REAL variables is used.  It is assumed that all variables take up four bytes.
Variables having DUMMY in the name indicates that they are not used by \smokeview.


\subsection{3D Smoke File Format}
3D smoke files contain alpha values used by Smokeview to draw
semi-transparent planes representing smoke, fire and water spray.
The \fds\ software outputs 3D smoke frames at fixed time
intervals. Note that char's are one byte, and ``int's'' and
float's are four bytes. A {\em pseudo-code}\ representation of the 3D
Smoke file is given by:

\begin{verbatim}
  endian flag (int)
  is1, is2, js1, js2, ks1, ks2 (6*int)
  version (int)
  for each time:
    time  (float)
    chars_uncompressed, chars_compressed (2*int)
    compressed_data (chars_compressed*char)
  end time
\end{verbatim}

The endian flag is an integer one.  Smokeview uses this number to
determine whether the computer creating the 3D smoke file and the
computer viewing the 3D smoke file use the same or different byte
swap (endian) conventions for storing floating point numbers.  The
opacity data is compressed using run-length encoding.

\subsection{Isosurface File Format}
Isosurface files are used to store one or more surfaces where each surface represents a region where
the solution take one a particular value.  The \fds\ software outputs isosurface frames at fixed
time intervals.  Note that char's are one byte, short's are two bytes and ``int's'' and float's are four bytes.
A {\em pseudo-code}\ representation of the isosurface file is given by:
\begin{verbatim}
version                                   (int)
len1,len2,len3                            (3*int)
label1,label2,label3                      ((len1+len2+len3+4)*char)
nlevels                                   (int)
level_1, level_2, ..., level_nlevels      (nlevels*float)
for each time:
  time                                    (float)
  for each level
    nvertices                             (int)
    ntriangles                            (int)
    vertices_1, ..., vertex_nvertices     (3*short*nvertices)
    triangles_1, ..., triangle_ntriangles (3*(byte/short/float)*ntriangles)
  end level
end time
\end{verbatim}

The length of each {\tt triangles\_i} node is one byte if
the number of triangles, {\tt ntriangles}, is between zero
and 255 (inclusive), two bytes if {\tt ntriangles} is
between 256 and 65536 (inclusive) and four bytes if {\tt
ntriangles} is greater than or equal to 65536. Note that
the isosurface files are written using the C programming
language.  These files should be read the same way unless
the programming language of choice supports binary I/O.


\subsection{Particle File Format}

Particle files are used to store smoke/tracer particles and/or sprinkler droplet
information.
The particle file consists of a header and a series of particle frames.
Each frame contains particle/droplet positions and data values for each
particle in that frame.
The \fds\ software outputs particle frames
at fixed time intervals but there is no requirement by
\smokeview\ for this to happen.
\Smokeview\ reads in the data one frame at a time noting the time read in for each frame.
The header can be described using the code segment:
\begin{verbatim}
      WRITE(IUNIT) DUMMY,DUMMY,DUMMY,IPART,NPPS
      WRITE(IUNIT) IBAR,JBAR,KBAR
      WRITE(IUNIT) (DUMMY,I=0,IBAR),(DUMMY,J=0,JBAR),(DUMMY,K=0,KBAR)
      WRITE(IUNIT) NB
      DO N=1,NB
        WRITE(IUNIT) IB1(N),IB2(N),JB1(N),JB2(N),KB1(N),KB2(N),1
      END DO
      WRITE(IUNIT) NV
      DO N=1,NV
        WRITE(IUNIT) IV1(N),IV2(N),JV1(N),JV2(N),KV1(N),KV2(N),2
      END DO
      WRITE(IUNIT) NSPR
      DO N=1,NSPR
        WRITE(IUNIT) XSP0(N),YSP0(N),ZSP0(N)
      END DO
\end{verbatim}
where {\tt DUMMY} is written by \fds\ but not needed by \smokeview,
{\tt IPART} is the index of the scalar
quantity associated with the particles, {\tt NPPS} is the maximum
number of particles per frame,
{\tt IB1, IB2,} \etc\ are the indices of blocked grid cells,
{\tt IV1, IV2,} \etc\ indicate vent cell nodes,
and {\tt XSP0, YSP0, ZSP0} are the coordinates of the
sprinklers. Grid coordinates are obtained by \smokeview\ from the \smokeview\ parameter
input file.
A particle frame is written using:
\begin{verbatim}
      WRITE(IUNIT) TIME,NP,IDUMMY,(ISPR(N),N=1,NSPR)
      WRITE(IUNIT) (XP(I),I=1,NP),
     .            (YP(I),I=1,NP),
     .            (ZP(I),I=1,NP),
     .            (BP(I),I=1,NP)
      IF (NASPR.GT.0) THEN
        WRITE(IUNIT) NSP
        WRITE(IUNIT) (XSP(I),I=1,NSP),(YSP(I),I=1,NSP),(ZSP(I),I=1,NSP)
      ENDIF
\end{verbatim}
where {\tt NP} is the number of particles in this frame,
{\tt ISPR} denotes whether the
sprinkler has activated, {\tt NSPR} is the number of sprinklers,
{\tt XP, YP, ZP} are the particle coordinates, {\tt BP} is the particle value,
{\tt NASPR} is the number of
active sprinklers, {\tt NSP} is the number of sprinkler droplets, and
{\tt XSP, YSP, ZSP} are the droplet coordinates.



\subsection{Slice File Format}

Slice files are unformatted.
The slice file header is written out using:
\begin{verbatim}
      WRITE(IUNIT) CDUMMY
      WRITE(IUNIT) CDUMMY
      WRITE(IUNIT) CDUMMY
      WRITE(IUNIT) I1,I2,J1,J2,K1,K2
\end{verbatim}
where {\tt CDUMMY} is a character strings of length 30.
\Smokeview\ obtains this information from the \smokeview\
parameter input file and not from the slice file. The
sextuple ({\tt I1,I2,J1,J2,K1,K2}) denotes the bounding
grid cell nodes of the slice to be displayed. The sextuple
indices correspond to grid cell nodes, or corners, thus the
entire grid would be represented by the sextuple ({\tt
0,IBAR,0,JBAR,0,KBAR}).  The grid node positions are
obtained from the \smokeview\ parameter input file.

The \fds\ software outputs slice frames
at fixed time intervals but there is no requirement by
\smokeview\ for this to happen.  Each slice frame is written using:
\begin{verbatim}
      WRITE(IUNIT) TIME
      WRITE(IUNIT) (((QQ(I,J,K),I=11,I2),J=J1,J2),K=K1,K2)
\end{verbatim}
where {\tt TIME} is the time in seconds when the data is ouput and {\tt QQ} are the data values.

\subsection{Terrain File Format}

Terrain files are unformatted and are output by the Wildland-Urban
interface (WUI) version of FDS.  The terrain file header is
written out using:
\begin{verbatim}
      WRITE(IUNIT) 1
      WRITE(IUNIT) VERSION
      WRITE(IUNIT) XMIN, XMAX, YMIN, YMAX
      WRITE(IUNIT) NX, NY
      WRITE(IUNIT) (ZELEV(I,J),I=1,NX),J=1,NY)
      WRITE(IUNIT) (STATE(I,J),I=1,NX),J=1,NY)
\end{verbatim}
The first ``1'' is used by Smokeview to determine whether the file
was written on a big or little endian computer.  {\tt VERSION} is
an integer value representing the file version (initially 1), {\tt
XMIN, XMAX, YMIN, YMAX} are floating point values defining the
terrain boundary, {\tt NX} and {\tt NY} are integers defining the
number of cells in the $x$ and $y$ direction, {\tt ZELEV} are
floating point values defining the elevation at each grid cell and
{\tt STATE} are one byte integers defining the states at each grid
cell.

The WUI \fds\ software outputs terrain frames at fixed time
intervals but there is no requirement by \smokeview\ for this to
happen. Because, cell states change infrequently, the cell states
are only output when they change.  Each terrain frame is written
using:
\begin{verbatim}
      WRITE(IUNIT) TIME
      WRITE(IUNIT) NCHANGES
      WRITE(IUNIT) (CELLINDEX(I),I=1,NCHANGES)
      WRITE(IUNIT) (CELLSTATES(I),I=1,NCHANGES)
\end{verbatim}
where {\tt TIME} is the time in seconds when the data is output,
CELLINDEX are the cell indices ($cellindex=(J-1)*NY + I - 1$) of
the cells that have changed state and CELLSTATES are the value of
the changed state.  The data for the very first time step (at
$t=0.0$) is not output explicitly but is assumed from information
previously output in the header.

\subsection{Boundary Files}

The boundary files are unformatted.
The header is written out using:
\begin{verbatim}
      WRITE(IUNIT) QUANTITY
      WRITE(IUNIT) SHORT_NAME
      WRITE(IUNIT) UNITS
      WRITE(IUNIT) NPATCH
      DO 10 I=1,NPATCH
        WRITE(IUNIT) IP1(I),IP2(I),JP1(I),JP2(I),KP1(I),KP2(I)
   10 CONTINUE
\end{verbatim}
where {\tt QUANTITY}, {\tt SHORT\_NAME} and {\tt UNITS} are
character strings of length 30,
{\tt NPATCH} is the number of planes (or {\em patches}) that make up the
solid boundaries plus the external walls.
The sextuple arrays ({\tt IP1,IP2,JP1,JP2,KP1,KP2}) defines the cell nodes of each
patch. The user does not prescribe these.

The \fds\ software outputs boundary frames
at fixed time intervals but there is no requirement by
\smokeview\ for this to happen.  The boundary file frame is written using:
\begin{verbatim}
      WRITE(IUNIT) TIME
      DO 10 I=1,NPATCH
        WRITE(IUNIT) (((QQ(I,J,K),I=IP1(I),IP2(I)),J=JP1(I),JP2(I)),K=KP1(I),KP2(I))
   10 CONTINUE
\end{verbatim}

\subsection{Plot3D Data}

Field data is dumped periodically by \fds\ in a format used by the
graphics package {\bf Plot3D}\cite{PLOT3D}. The {\bf Plot3D} data
sets are single precision (32 bit reals), whole and unformatted.
Note that there is blanking, that is, blocked out data points are
not plotted. The grid data is written out to a file called {\tt
casename.xyz} using:
\begin{verbatim}
      WRITE(IUNIT) IBAR+1,JBAR+1,KBAR+1
      WRITE(IUNIT) (((X(I),I=0,IBAR),J=0,JBAR),K=0,KBAR),
     .            (((Y(J),I=0,IBAR),J=0,JBAR),K=0,KBAR),
     .            (((Z(K),I=0,IBAR),J=0,JBAR),K=0,KBAR),
     .     (((IBLK(I,J,K),I=0,IBAR),J=0,JBAR),K=0,KBAR)
\end{verbatim}
where {\tt IBAR+1, JBAR+1, KBAR+1} are the number of grid cells along the
{\tt I, J, K} coordinate directions, {\tt X, Y} and {\tt Z}
are the physical coordinates of the cell corners,
and {\tt IBLK} is an indicator of whether or not the cell is blocked.
If the point ({\tt X,Y,Z}) is completely embedded within a solid region,
then {\tt IBLK} is 0. Otherwise, {\tt IBLK} is 1.
The flow variables are written to a file using:
\begin{verbatim}
      WRITE(IUNIT) IBAR+1,JBAR+1,KBAR+1
      WRITE(IUNIT) ZERO,ZERO,ZERO,ZERO
      WRITE(IUNIT) ((((QQ(I,J,K,N),I=0,IBAR),J=0,JBAR),K=0,KBAR),N=1,5)
\end{verbatim}
The five channels {\tt N=1,5} are by default the temperature
(C), the $u$, $v$ and
$w$ components of the velocity (m/s), and the heat release rate
per unit volume (kW/m$^3$).

\subsection{CAD/GE1 file format}

A program called DXF2FDS, written by David Sheppard of the US Bureau of Alcohol, Tobacco and Firearms (ATF), creates an FDS
input file and a Smokeview geometric description file (.GE1) given
a CAD description of the building being modelled.  The CAD
description must be in a {\em dxf}\ format and created using {\em 3DFACE}\ commands.  The .GE1 file has a simple text format and is
described below. Details of this program can be found at the FDS/Smokeview website, \hhref{http://fire.nist.gov/fds/}.

\begin{verbatim}
[APPEARANCE]
nappearances
string (material description)
index r g b twidth, theight
tfile
:
:   The above entry is repeated nappearances-1 more times
:
[FACES]
nfaces
x1 y1 z1 x2 y2 z2 x3 y3 z3 x4 y4 z4 index
The above line is repeated nfaces-1 more times.
\end{verbatim}

\blist

\hitem{nappearances} Number of appearance entries to follow
Each appearance entry has 3 lines.
\hitem{string} A material description is written out by DX2FDS but is ignored by Smokeview.
\hitem{index} An index number starting at 0.
\hitem{r, g, b} Red green and blue components of the CAD face used when a texture is not drawn.
The values of r, g and b range from 0 to 255.  If a color is not used then use -1 for each color component.
\hitem{twidth, theight} Textures are tiled or repeated.  The characteristic width and length of the
texture file is twidth and theight respectively.
\hitem{tfile} The name of the texture file.  If one is not used or available then leave this line blank.
\hitem{nfaces} Number of face entries to follow.  Each face entry has one line.
\hitem{x1/y1/z1/.../x4/y4/z4}x,y,z coordinates of a quadrilateral.  The four corners of the quad
must lie in a plane or weird effects may result when Smokeview draws it.  (This is a requirement
of OpenGL).  The four points should be in counter-clockwise order.
\hitem{index} Points to a material in the [APPEARANCE] section.
\elist

