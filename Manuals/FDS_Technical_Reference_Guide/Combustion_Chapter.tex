\chapter{Combustion (Chemically Reacting Flows)}

\label{combustionsection}
The combustion routine is responsible for determining the mean chemical mass production rate of species $\alpha$ per unit volume, $\dot{m}^{\prime\prime\prime}_{\alpha}$ in the species transport equation, Eq.~(\ref{species}). In this chapter, we integrate the change in species concentration over a time step for a single grid cell:
\begin{equation}\label{eq:m_tprime_alpha}
\dot{m}^{\prime\prime\prime}_{\alpha}=\rho \,\frac{Y_\alpha(\delta t) - Y_\alpha(0)}{\delta t}
\end{equation}
The integration of the mean chemical source term is time split from the integration of the transport equation such that each cell may be thought of as a partially-stirred batch reactor.  As we discuss below, given the chemical composition, cell temperature, and extent of mixing at the start of the time step, the final cell composition depends on the rates of chemical kinetics and turbulent mixing.

The combustion routine also returns the heat release for per unit volume, $\dot{q}^{\prime\prime\prime}$, a quantity of fundamental importance in fire dynamics and typically the largest contribution to the flow divergence, Eq.~(\ref{eqn_fdsD1}).  The heat release rate is found by summing the lumped species mass production rates times their respective heats of formation:
\begin{equation}\label{eq:q_tprime}
\dot{q}^{\prime\prime\prime} \equiv -\displaystyle \sum_{\alpha} \dot{m}_\alpha^{\prime\prime\prime} \Delta H_{f,\alpha}
\end{equation}

{\bf Add a short paragraph describing the organization of the rest of the chapter.}


\section{Lumped Species Approach}
In the typical FDS problem we consider the simple reaction:
\begin{equation}\label{eq:simple}
\mathrm{Fuel + Air \rightarrow Products}
\end{equation}
We refer to fuel, air, and products as \emph{lumped species}.  The lumped species approach is a simplified reaction progress variable approach \cite{fox2003} in which all the progress variables behave as mass fractions. This avoids the complications related to unbounded values and ill-defined initial and boundary conditions in the traditional approach.

In a simple hydrocarbon reaction, reactants can be fuel, oxygen, and nitrogen with products being carbon dioxide, water vapor, and nitrogen. The primitive species mass fractions are given by the composition vector:
\begin{equation}\label{eq:prim_vector}
\mathbf{Y} = [Y_{\mathrm{CH}_4}\, \, Y_{\mathrm{O}_2}\, \, Y_{\mathrm{N}_4}\, \, Y_{\mathrm{CO}_2}\, \, Y_{\mathrm{H}_2\mathrm{O}}]^T
\end{equation}
Lumped species are groups of primitive species which only exist in the flow in certain proportions. For example, `air' can be assumed to be a lumped species composed of 21\% O$_2$ and 79\% N$_2$ by volume. The key assumption made in lumping primitive species is that the new species groups transport (implying equal diffusivities) and react together. 

We can expand Eq.~(\ref{eq:simple}) to show the components of the lumped species for a simple, one-step methane reaction. 
\begin{equation}\label{eq:lumped_expand}
\mathrm{2\underbrace{(\mbox{O}_2+(.79/.21)\mbox{N}_2)}_\text{Background,~Z$_0$}+\underbrace{\mbox{CH}_4}_\text{Fuel,~Z$_1$} \rightarrow 1\underbrace{(\mbox{CO}_2+2\mbox{H}_2\mbox{O}+2(.79/.21)\mbox{N}_2)}_\text{Products,~Z$_2$}}
\end{equation}
As described by Eq.~(\ref{eq:lumped_expand}), two moles of the lumped species `Background' react with one mole of lumped species `Fuel', to produce one mole of lumped species `Products'. In FDS, the background species is not transported but solved for since the sum of the mass fractions of the lumped species must be 1. Lumped species are defined by the vector $\textbf{Z}$ which is indexed from $0:N_{z}$ by the Roman numeral $i$. This means that $N_{z}$ transport equations are solved. In the case of Eq:~(\ref{eq:lumped_expand}), two transport equations are solved (fuel and products) which is the same number solved in the mixture fraction progress variable approach.

To convert from lumped species to primitive species, we need to find the mass fractions of the primitive species within a particular lumped species as if the lumped species mass fraction were one. The transformation matrix, $A$, is $N_{y} \times (N_{z}+1)$ (rows $\times$ columns) since it includes the background species. Transformation from lumped species to primitive species is defined by: 
\begin{equation}\label{eq:transform}
\textbf{Y}=A\textbf{Z} 
\end{equation}
The elements in $A$ are the mass fractions for each primitive species in a given lumped species:
\begin{equation}\label{eq:A_def}
A_{\alpha\,i} = \frac{\upsilon_{\alpha\,i}W_{\alpha}}{\displaystyle \sum_{\alpha}\upsilon_{\alpha i}W_{\alpha}}
\end{equation}
where $\upsilon_{\alpha\,i}$ are the volume ratios of primitive species $\alpha$ in lumped species {i}.

If we look at the primitive species in Eq.~(\ref{eq:lumped_expand}) and for example set $\mathbf{Z} = [0.3\, \, 0.2\, \, 0.5]^\mathrm{T}$, we can transform from lumped species to primitive species:

\begin{displaymath}
\mathbf{Y}=\left[\begin{array}{c}
       Y_{O_2} \\
       Y_{N_2} \\
       Y_{CH_4} \\
       Y_{CO_2} \\
       Y_{H_2O} \\
     \end{array}\right]
     =\left[\begin{array}{ccc}
     0.2330 & 0 & 0 \\
     0.7670 & 0 & 0.7248 \\
     0 & 1 & 0 \\
     0 & 0 & 0.1514 \\
     0 & 0 & 0.1238 \\
     \end{array}\right]
     \left[\begin{array}{c}
     0.3 \\
     0.2 \\
     0.5 \\
     \end{array}\right]
     =\left[\begin{array}{c}
     0.0699\\
     0.5925\\
     0.2000\\
     0.0757\\
     0.0619\\
     \end{array}\right]
\end{displaymath}
To transform back to lumped species from primitive species we can use:
\begin{equation}\label{eq:transform_back}
\textbf{Z}=B\textbf{Y} \, \, \, \text{where} \, \, \, \, B=(A^TA)^{-1}A^T
\end{equation}

\subsection{Specified CO and Soot Yield}
The default reaction system in FDS is fuel plus oxidizer goes to products, where the products are carbon dioxide, water vapor, nitrogen, carbon monoxide, and soot. Carbon monoxide and soot yields are zero by default. The user can specify the CO and soot yields ($y_{\mathrm{CO}}$ and $y_{\mathrm{S}}$ respectively) on the {\ct REAC} line which determine the composition of the {\ct PRODUCTS} lumped species. In this reaction system, {\ct AIR} (background) is lumped species 0, the {\ct FUEL} is lumped species 1, and {\ct PRODUCTS} are lumped species 2. To find the stoichiometric coefficients of CO and soot within the product lumped species, FDS uses:  

\begin{eqnarray}\label{eq:yields}
\nu_{2}\upsilon_{\mathrm{CO},2}&=&-\nu_{1}\frac{W_1}{W_{\mathrm{CO}}}y_{\mathrm{CO}} \\
\nu_{2}\upsilon_{\mathrm{S},2}&=&-\nu_{1}\frac{W_1}{W_{\mathrm{S}}}y_{\mathrm{S}}
\end{eqnarray}
The remaining coefficients come from an atom balance. Consider a methane - air reaction where methane has a specified CO yield of $y_{\mathrm{CO}}=0.1$ and Soot yield of $y_{\mathrm{S}}=0.01$. The default FDS reaction system lumps these species into the {\ct PRODUCTS} lumped species. Note that by default, air is primarily composed of oxygen and nitrogen but includes trace amounts of carbon dioxide and water vapor. For this reaction the transformation matrix, $A$, is:

\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline  & {\ct AIR} & {\ct FUEL} & {\ct PRODUCTS} \\ \hline \hline
{CH$_4$}           & 0.000000 & 1.000000 & 0.000000 \\
{N$_2$}            & 0.763017 & 0.000000 & 0.720373 \\
{O$_2$}            & 0.231163 & 0.000000 & 0.000000 \\
{CO$_2$}           & 0.000592 & 0.000000 & 0.143067 \\
{CO}               & 0.000000 & 0.000000 & 0.005589 \\ 
{H$_2$O}           & 0.005228 & 0.000000 & 0.130412 \\
{C}                & 0.000000 & 0.000000 & 0.000559 \\ \hline
\end{tabular}
\end{center}

The preceding table shows that the addition of carbon monoxide and soot has increases the number of primitive species in the reaction from five to seven, however the number of lumped species remains at three. The composition of {\ct PRODUCTS} has changed to include to the two additional species.

For a typical hydrocarbon fuel, the chemical reaction in FDS follows:

\begin{eqnarray}\label{eq:full_lump}
\nu_{0}\underbrace{(\upsilon_{\mathrm{O}_{2},0}\mathrm{O}_2+\upsilon_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\upsilon_{\mathrm{CO}_{2},0}\mathrm{CO}_2+\upsilon_{\mathrm{N}_{2},0}\mathrm{N}_2)}_\text{Background,~Z$_0$}+\nu_{1}\underbrace{\mbox{C}_m\mbox{H}_n\mbox{O}_a\mbox{N}_b}_\text{Fuel,~Z$_1$} \rightarrow \\
\nonumber \nu_{2}\underbrace{(\upsilon_{\mathrm{CO}_{2},2}\mathrm{CO}_2+\upsilon_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\upsilon_{\mathrm{N}_{2},0}\mathrm{N}_2+\upsilon_{\mathrm{CO},2}\mathrm{CO}+\upsilon_{\mathrm{S},2}\mathrm{S})}_\text{Products,~Z$_2$}
\end{eqnarray}
Here the volume fraction of primitive species $\alpha$ in lumped species $i$ is denoted by $\upsilon_{\alpha\,i}$ and the stoichiometric coefficients for the lumped $i$ are denoted by $\nu_{i}$.


\subsection{Use of Primitive Species}
There are cases where the use if primitive species is needed, such as water droplet evaporation or complex chemical reactions. In sprinkler activation cases, there is water vapor that is produced by fuel combustion that lives in the {\ct PRODUCTS} lumped species and there is water vapor that is produced from liquid water droplet evaporation. The evaporated water vapor cannot simply be added to the lumped species, because by definition, lumped species exist in the same proportion as which they were initially defined. As a result, the evaporated water vapor is transported as its own lumped species and then combined with the chemical reaction produced water vapor through the transformation matrix.   

If we revisit Eq.~(\ref{eq:full_lump}) but decompose the reaction into all primitive species, we get:
\begin{eqnarray}\label{eq:prim}
\nu_{\mathrm{O}_{2},0}\mathrm{O}_2+\nu_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\nu_{\mathrm{CO}_{2},0}\mathrm{CO}_2+\nu_{\mathrm{N}_{2},0}\mathrm{N}_2+\nu_{\mathrm{fuel},0}(\mbox{C}_m\mbox{H}_n\mbox{O}_a\mbox{N}_b) \rightarrow \\
\nonumber \nu_{\mathrm{CO}_{2},2}\mathrm{CO}_2+\nu_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\nu_{\mathrm{N}_{2},0}\mathrm{N}_2+\nu_{\mathrm{CO},2}\mathrm{CO}+\nu_{\mathrm{S},2}\mathrm{S}
\end{eqnarray}
In this formulation, we would have to solve transport equations for six species compared to two when the species were lumped. Note that in cases with all primitive species, $A$ becomes an identity matrix:

\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|}
\hline  & {CH$_4$} & {N$_2$} & {O$_2$} & {CO$_2$} & {CO} & {H$_2$O} & {C} \\ \hline \hline
{CH$_4$}            & 1.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\
{N$_2$}             & 0.00 & 1.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\
{O$_2$}             & 0.00 & 0.00 & 1.00 & 0.00 & 0.00 & 0.00 & 0.00 \\
{CO$_2$}            & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 & 0.00 & 0.00 \\
{CO}                & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 & 0.00 \\ 
{H$_2$O}            & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 \\ 
{C}                 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 \\\hline
\end{tabular}
\end{center}
For cases that explicitly track all of the primitive species, FDS could end up solving upwards of 10-20 transport equations depending on the case, with each additional tracked species adding a 5~\% computational cost.



\section{Turbulent Combustion}
FDS can model multiple, simultaneous, reversible chemical reactions.  In FDS only the species that have mixed have the potential to react. Once mixed, FDS uses one of two approaches to compute the reaction rate for a chemical reaction.  The first approach is an infinite fast chemical reaction rate. That is, the reactants (e.g., fuel and air) react infinitely fast at the rate that the underlying gas transport mixes them together.  For the second model, individual gas species react according to specified Arrhenius reaction parameters. The Arrhenius rate can still be limited by the amount of mixing within a computational cell. This latter model is most often used in a direct numerical simulation (DNS) where the diffusion of fuel and oxygen can be modeled directly. However, most often for large eddy simulations (LES), where the grid is not fine enough to resolve the diffusion of fuel and oxygen, the mixing-controlled combustion model is assumed. A single FDS simulation can contain a mix of reaction rate types.

Mathematically modeling chemical reactions is challenging because of turbulence chemistry interactions; coupling turbulent flow within a computational cell and the kinetics that describe the chemical reactions. The model used to close the mean chemical source term, $\dot{m}^{\prime\prime\prime}_{\alpha}$ in Eq.~(\ref{species}) is the Eddy Dissipation Concept (EDC) \cite{Magnussen:1}. In the EDC, each computational cell can be thought of as a batch reactor. Within the batch reactor, there exits two environments: the mean concentration of species which FDS transports and the amount of mixing within the reactor. At the start of an FDS time step, each cell has an initial concentration of species (reactants, products, inerts) that exist in some degree of mixing. Currently, each cell is completely unmixed at the start of a time step. The rate of mixing is driven by the mean species concentration and the mixing time, $\tau_{mix}$; detailed discussion of $\tau_{mix}$ can be found in section \ref{sec:reac_time_scale}. Once mixed, species can react based on user specified reaction parameters. Section \ref{sec:EDC} discusses the model that couples mixing and chemical reactions. 

\subsection{Reaction Time Scale Model}
\label{sec:reac_time_scale}

In the fast chemistry limit, our task is to provide an expression for the mixing time based on the local state of the flow field.  The basic idea behind the model we propose here is to consider the three physical processes of diffusion, subgrid-scale (SGS) advection, and buoyant acceleration and to take the fastest of these processes (locally) as the controlling flow time scale.

It is important to consider the behavior of a model as the filter width varies. The mixing times for diffusion, SGS advection, and buoyant acceleration scale differently with filter width and if we look to the limits of the filter scales an interesting picture emerges.  Referring to Fig.~\ref{fig_reaction_time_scale}, let us move from left to right along the horizontal axis following the thick black line which represents our time scale model for a hypothetical flow condition.  First, notice that the reaction time scale must be greater than or equal to the chemical time scale which, though small, is finite. At a slightly larger scale we expect the mixing time to vary as the square of the filter width because the mixing is controlled by molecular diffusion.  In this regime, denoted $\tau_d$, the numerical solution is a DNS and this scaling law is valid while $\Delta$ is less than the Kolmogorov scale, $\eta$, the length scale of the smallest turbulent eddies. For a sufficiently high Reynolds number flow (such that an inertial subrange exists), as the filter width increases beyond the Kolmogorov scale we encounter a regime, marked $\tau_u$, where turbulent advection controls the rate of mixing and the mixing time varies as the two thirds power of the filter width \cite{Pope:2000} (we will see why later).  This is the regime where most LES submodels are valid.

Now let us imagine what should happen to the mixing time as the filter width increases beyond the inertial subrange to a length scale larger than the height of the flame itself (actually a possibility in wildfire modeling). We would \emph{not} expect the inertial range scaling to continue up through the so-called ``energy-containing'' range of turbulent length scales.  Rather, for fires--which are generally buoyancy-driven flows--we expect buoyant acceleration to control the mixing at these relatively coarse scales.  A time scale based on a constant acceleration goes as the square root of the filter width, as shown by the regime marked $\tau_g$ in the diagram.  This shift in scaling may appear minor given the log-log nature of the plot. But, as we will see, the effect of the acceleration-based time scale is indeed significant for large cell sizes.  Finally, note that the flame height presents a limit to the reaction time scale, here denoted $\tau_{flame}$, since all fuel must be consumed within a single cell.

\begin{figure}[t]
\centering
\includegraphics[width=4.5in]{FIGURES/reaction_time_scale.pdf}
\vskip-.2cm
\caption{Reaction time scale model.}
\label{fig_reaction_time_scale}
\end{figure}

Of course, the relative importance of the physical processes will depend on the flow.  For example, if gravity is weak the $\tau_g$ line shifts up and may not affect the reaction time before the flame time scale is reached.  If the flow is highly turbulent, the inertial range scaling may be more dominant, which would be indicated by a lowering of the $\tau_u$ line.  Or, for highly turbulent jet flames $\tau_{flame}$ may be reached before the acceleration time scale has any effect.  Perhaps more typical for low strain fires, if an inertial subrange does not exist (if the Reynolds number is too low relative to the Froude number), then the $\tau_u$ line in Fig.~\ref{fig_reaction_time_scale} moves up out of the picture and we are left with diffusion and buoyancy to control the mixing.

The bold solid line in Fig.~\ref{fig_reaction_time_scale} is mathematically represented by
\begin{equation}
\label{eqn_tau_mix}
\tau_{mix} = \max(\tau_{chem},\min(\tau_d,\tau_u,\tau_g,\tau_{flame}))
\end{equation}
The mathematical details of the submodels are as follows:
\begin{equation}
\label{eq:tau_diff}
\begin{array}{rcl}
\mathnormal{\tau_{d}} &=& \displaystyle \frac{\mbox{Sc}_t\bar{\rho}\Delta^2}{\mu + \mu_t}
\end{array}
\end{equation}
\vspace{-.5\baselineskip}
\begin{equation}
\label{eq:tau_sgs}
\begin{array}{rcl}
\tau_{u} &=& \displaystyle \frac{\Delta}{\sqrt{2k_{sgs}}}
\end{array}
\end{equation}
\vspace{-.5\baselineskip}
\begin{equation}
\label{eqn_tau_grav}
\begin{array}{rcl}
\tau_{g} &=& \displaystyle \sqrt{ 2\Delta/g }
\end{array}
\end{equation}

Note that $k_{sgs}$ is the unclosed subgrid kinetic energy per unit mass which is discussed further below. The acceleration time scale $\tau_{g}$ is the time required to travel a distance $\Delta$ starting from rest under a constant acceleration, $g=9.81$ m/s$^2$.

{\bf Remark} The turbulent viscosity is included in the diffusion time scale in Eq.~\ref{eq:tau_diff} and the reader may wonder why the diffusion time scale does not then also account for turbulent advection.  This idea is reasonable and in fact FDS uses such a model.  The shortcoming of the approach is that a proportionality constant is required in the expression and the correct diffusion behavior is then not recovered as $\Delta \rightarrow 0$.  In FDS, the model constant used in front of Eq.~\ref{eq:tau_diff} is 0.1, so for our proposed model $\tau_d > \tau_u$ in the subgrid advection regime.  By including the turbulent viscosity in $\tau_d$, however, the diffusion time scale helps bridge the gap between dissipation and inertial range scaling.

\subsubsection{Estimating the Subgrid Kinetic Energy}

If the mixing is controlled by unresolved turbulent advection we presume that an inertial subrange of length scales exists and that the filter width lies within this range.  The subgrid kinetic energy may then be estimated by integrating a Kolmogorov spectrum \cite{Pope:2000} from the filter wavenumber ($\kappa = \pi/\Delta$) to the smallest possible length scales (highest wavenumbers),
\begin{equation}
\label{eqn_ksgs}
\begin{array}{rcl}
k_{sgs} &=& \displaystyle C \,\varepsilon^{2/3} \int_{\pi/\Delta}^{\infty} \kappa^{-5/3} \,\mbox{d} \kappa \\
\\
&=& \displaystyle C \,\varepsilon^{2/3} \frac{3}{2} \left(\frac{\Delta}{\pi}\right)^{2/3}
\end{array}
\end{equation}
where $C=1.5$ is the Kolmogorov constant \cite{Pope:2000} and $\varepsilon$ is the kinetic energy dissipation rate (which requires closure, as discussed below).  It is convenient to take the upper limit of integration as infinite, since (a) the integral converges and the result is quite simple, and (b) if the dissipation range is important to the time scale we are likely in a regime where $\tau_d < \tau_u$.  We therefore currently avoid the need to explicitly model the high-wavenumber spectrum.  However, this may be revisited in the future if deemed necessary.  Note that combining Eq.~\ref{eqn_tau_sgs} with Eq.~\ref{eqn_ksgs} leads to $\tau_u \sim \Delta^{2/3}$ which explains the two thirds scaling mentioned above and shown in Fig.~\ref{fig_reaction_time_scale}.

For closure we require a model for the dissipation rate which is a physical parameter of the flow.  The ideal model, therefore, does not vary with filter width (remember, the filter width is a user-specified artificial parameter).  The model we employ assumes that production of subgrid-scale kinetic energy is equal to the dissipation of total kinetic energy \cite{Pope:2000},
\begin{equation}
\label{eqn_dissipation}
\varepsilon = (\mu_t/\bar{\rho}) \, |\tilde{S}|^2 % - \frac{2}{3} (\nabla\!\cdot \mathbf{u})^2 \right) 
\end{equation}
where $|\tilde{S}| \equiv (2 \tilde{S}_{ij} \tilde{S}_{ij})^{1/2}$ is the filtered rate of strain invariant.  Pope \cite{Pope:2000} discusses the important observation that $|\tilde{S}|\sim \Delta^{-2/3}$ for $\Delta$ in the inertial subrange of an incompressible flow.  For this limiting case, the constant coefficient Smagorinsky model gives $(\mu_t/\bar{\rho}) = (C_s \Delta)^2 |\tilde{S}| \sim \Delta^{4/3}$ and we find the dissipation rate is correctly invariant with filter width, $\varepsilon \sim \Delta^{4/3} (\Delta^{-2/3})^2 \sim \Delta^0$.

\subsection{Eddy Dissipation Concept}
\label{sec:EDC} 
Within the batch reactor, the proportion of the cell that is mixed is the unmixed fraction, $\zeta(t;\tau_{mix})$. A cell can range from completely unmixed ($\zeta=1$) to completely mixed ($\zeta=0$). In a combustion sense, $\zeta=1$  represents a diffusion flame and $\zeta=0$ represents a premixed flame. The amount of mixing within a computational cell is defined by:
\begin{equation}\label{eq:zeta}
\frac{\mbox{d}\zeta}{\mbox{d}t}=-\frac{\zeta}{\tau_{mix}}
\end{equation}
The governing mixing model physics are included in Eq.~(\ref{eq:zeta}) through the definition of the unmixed fraction while the turbulence physics are buried within the mixing time. Presently in FDS, the Interaction by Exchange with Mean (IEM) mixing model is used \cite{fox2003}. The IEM says that scalar values ($\psi$) will relax to their mean at a rate based on the mixing time and distance the scale value is from its mean value.  If, for $n_{\alpha}$ species, we define $\zeta$ to be:
\begin{equation}\label{eq:zeta_def}
\zeta \equiv \frac{\displaystyle \sum_{\alpha}(\psi_{\alpha}- \langle \psi_{\alpha} \rangle )}{n_{\alpha} - 1}
\end{equation}
we can show that Eq.~(\ref{eq:zeta}) becomes the IEM model by substituting in the definition of $\zeta$, Eq.~(\ref{eq:zeta_def}).
\begin{equation}\label{eq:iem1}
\displaystyle \sum_{\alpha}\left(\frac{1}{n_{\alpha}-1}\right) \frac{\mbox{d}\psi_{\alpha}}{\mbox{d}t} = - \left(\frac{1}{\tau_{mix}}\right) \left(\frac{1}{n_{\alpha}-1} \right) \displaystyle \sum_{\alpha}(\psi_{\alpha}- \langle \psi_{\alpha} \rangle)
\end{equation}
We can simplify Eq.~(\ref{eq:iem1}) and obtain the IEM model \cite{fox2003}:
\begin{equation}\label{eq:iem2}
\frac{\mbox{d}\psi}{\mbox{d}t} = \frac{1}{\tau_{mix}}(\langle \psi \rangle - \psi)
\end{equation}
      
Since only those species in the mixed environment can react, the proportion of the cell (reactor) composition in the mixed state must be known as function of time. The following equations define the cell composition:
\begin{eqnarray}\label{eq:mixunmix}
\rho V &=& U(t) + M(t) \\
U(t) &=& \zeta(t)\,\rho V \\
M(t) &=& (1-\zeta(t))\,\rho V
\end{eqnarray} 
where $\rho V$ is the total mass in the reactor, $U(t)$ is unmixed portion of the mass, and $M(t)$ is the mixed portion of the mass. Cell mass, $\rho V$, is not a function of time as the total mass in a cell remains constant during a single FDS time interval. From the portion of mass that is mixed, $M(t)$, the local mixed composition ($\phi_{\alpha}(t)$) is found by:

\begin{equation}\label{eq:phi}
\phi_{\alpha}(t)=\frac{m_{\alpha}(t)}{M(t)}
\end{equation}
where $m_\alpha(t)$ is the mixed mass of each of the $\alpha$ species in the simulation. The mixed mass of each species as a function of time is governed by:

\begin{equation}\label{eq:mixmass}
\frac{\mbox{d}m_{\alpha}}{\mbox{d}t}=M\frac{\nu_{\alpha} \, W_{\alpha}}{W_F}\displaystyle \sum_{i\,>1}^{\mathrm{N_{R}}}\frac{\mbox{d}\phi_{\F,i}}{\mbox{d}t}+Y_{\alpha,0}\frac{\mbox{d}M}{\mbox{d}t} 
\end{equation}
where $Y_{\alpha,0}$ is the mass fraction of each $\alpha$ species in the unmixed portion of the cell. The mass fractions of each species in the unmixed portion remain constant over an integration time step therefore the proportion of species which mix remains constant. The rate at which species react, $\mbox{d}\phi_\F/\mbox{d}t$, is discussed in section \ref{Reaction_Rate_Model}. The complete composition of the computational cell is found by a combination of the unmixed and mixed portions:

\begin{equation}\label{eq:final_comp}
Y_{\alpha}(t)=\zeta(t)Y_{\alpha,0}+(1-\zeta(t))\phi_{\alpha}(t)
\end{equation}
Finally the chemical mass production rate, $\dot{m}^{\prime\prime\prime}_{\alpha}$, is:
\begin{equation}\label{mass_prod_rate}
\dot{m}^{\prime\prime\prime}_{\alpha}=\rho \,\frac{\mbox{d}Y_{\alpha}}{\mbox{d}t} \approx \rho \left(\frac{Y_{\alpha}(\delta t) - Y_{\alpha,0}}{\delta t}\right)
\end{equation}

\subsubsection{Multi-environment Extension of EDC}
In the current formulation of the EDC there are two environments: the mean species concentrations which FDS currently transports and the amount of mixing within a cell (unmixed fraction) which FDS does not transport. Since FDS does not transport the mixing variable, at the start of a time step, the mixing environment is assumed to be at its mean value in the unmixed state. We would like to extend this approach to more mixing environments and eventually build PDFs of reactor concentration. The difficulty is how to construct/transport all of the information within a PDF.

One efficient way to describe a PDF is to use a moment; where a moment can be thought of a statistical descriptor of the distribution. The first moment of a distribution is the mean of the distribution, the second is the variance, etc. Therefore, the more moments we know, the better the description of the distribution we have. For a given PDF, p(y), the $k^{th}$ moment of $y$ of the distribution is:
\begin{equation}\label{eq:int_moment}
_{y}M_{k} = \int y^{k}p(y)\mathrm{d}y
\end{equation}
Solving this integral equation can become difficult as it requires the function form of the PDF. As an alternative way to compute moments, the quadrature method of moments was developed, which represents the moment integral in Eq.~\ref{eq:int_moment} as an n-point sum \cite{mcgraw:1997}:
\begin{equation}\label{eq:qmom}
_{y}M_{k}=\displaystyle \sum_{i=1}^{n} \hat y_{i}^{k} w_{i}
\end{equation}
This technique is known as the quadrature method of moments (QMOM) where  $\hat y_i^k$ is known at the $i^{th}$ quadrature point, $w_i$ is known as the $i^{th}$ quadrature weight, and $n$ is the number of quadrature points. If we consider the unmixed fraction as a weight describing the amount of mixing, the steps to obtain higher order statistics about the batch reactor composition begin to take shape. The unmixed fraction, $\zeta$, exists in two probabilistic states: $p1$ and $p2$, where $p2 = 1-p1$. State 1 ($p1$) describes the amount of the cell that is mixed while state 2 ($p2$) describes the unmixed portion. If we know the mass fractions of species in both mixing states (quadrature points) and the corresponding weights to those states, then we can use QMOM to cons the reactor distribution.

If we apply this to the current formulation, the quadrature weights become the unmixed fraction, $\zeta_{i}$, and the quadrature points become the mass fractions $\phi_{\alpha,i}$. Applying this to Eq.~\ref{eq:qmom} the moments of the distribution in the reactor are:
\begin{eqnarray}\label{eq:moments}
M_{0} &=& \displaystyle \sum_{i=1}^{n} \zeta_{i} \\
\nonumber M_{1} &=& \displaystyle \sum_{i=1}^{n} \zeta_{i} \phi_{\alpha,i} \\
\nonumber M_{2} &=& \displaystyle \sum_{i=1}^{n} \zeta_{i} \phi_{\alpha,i}^2
\end{eqnarray}
The mean of the distribution becomes $M_{1}$ and the centered standard deviation becomes $\sqrt{M_{2}-M_{1}^{2}}$. For this concept to be implemented, further works needs to be done in developing an efficient way to transport the unmixed fraction and the concentrations that exist within each state.

\section{Heat Release Rate}

Each chemical reaction in FDS must be defined with a fuel and sufficient information such that a heat of formation is known for each participating species. The heat release per unit volume is found by summing the species mass production rates by the respective species heat of formation:
\begin{equation}\label{eq:vol_heat_gen}
\dot{q}^{\prime\prime\prime} \equiv -\displaystyle \sum_{\alpha} \dot{m}^{\prime\prime\prime}_{\alpha} \Delta H_{f,\alpha}
\end{equation}
There is a need, in certain situations, to put an upper bound on the local heat release rate per unit volume. The reason for
this is that FDS is applied over length scales ranging from millimeters to tens of meters, and the resolution of the numerical grid
is sometimes too coarse to work effectively.
A scaling analysis of pool fires by Orloff and de Ris~\cite{Orloff:19th_Symposium} suggests that the spatial average of the
heat release rate of a fire is approximately 1200~kW/m$^3$. FDS uses a less restrictive upper bound on the local heat release rate per unit volume:
\begin{equation}\label{eq:q_bound} 
\dq_{\max}''' = 200/\dx + 2500 \quad \hbox{kW/m}^3 
\end{equation}
The value of 200~kW/m$^2$ is an upper bound on the heat release rate per unit area of flame sheet and $\delta x$ is the characteristic cell size (m). Typically, this bound only affects fires whose value of $Q^*$ is less than one\footnote{The non-dimensional quantity, $Q^*$, is a measure of the fire's heat release rate divided by the
area of its base. It is expressed as $Q^*=\dQ/(\rho_\infty c_p T_\infty \sqrt{g D} D^2)$.}.

\section{Reaction Rate} 

\label{Reaction_Rate_Model}

The rate expression (on a fuel basis) for both infinitely fast chemistry and Arrhenius rate chemistry follow the same general form:
\begin{equation}\label{eq:Arrheniusrateeqn}
\frac{\mbox{d}[X_\F]}{\mbox{d}t} = -A \; \prod \left([X_{\alpha}]^{a_{\alpha}} \right) T^n \; e^{-E/RT} 
\end{equation}
Note that the rate expression can be dependent on temperature and that the rate can be dependent upon species that do not directly participate in the reaction. Since FDS solves for mass fractions of lumped species rather than mole fractions of individual species, the only "species" that can be consumed or created are the lumped species.  However, any of the primitive species components of those lumped species could participate as a collision species.  Therefore, rather than $\mbox{d}[X_\F]/\mbox{d}t$,  FDS must solve for $\mbox{d}\phi_\F/\mbox{d}t$.  Additionally since it is quicker to determine $\phi_i$ rather than $X_i$, the relation $[X_i]=\phi_i \rho/W_i$ is used.  Combined, these result in a modified rate equation:

\begin{equation}\label{eq:Arrheniusratemode}
\frac{\mbox{d}\phi_\F}{\mbox{d}t} = -A_{mod} \rho^{\sum (a_{\alpha}) -1} \; \prod \left(Y_{\alpha}^{a_{\alpha}} \right) T^n \; e^{-E/RT} \;\;\; A_{mod} = A \prod \left(W_{\alpha}^{-a_{\alpha}} \right)  
\end{equation}

\subsection{Infinitely Fast Reaction}
For fast chemistry reactions, $E$ and $n$ in Eq.~(\ref{eq:Arrheniusratemode}) are set to $0$ which removes the temperature dependence from the rate expression. The species exponents, $a_{\alpha}$, are also set to zero to remove concentration dependence. Finally, the pre-exponential, $A$, is set to $1 \times 10^{16}$. In this formulation, $\mbox{d}\phi_\F/\mbox{d}t$ becomes sufficiently large such that all of the fuel in a computational cell is consumed in a single time step, effectively making the rate infinite. However, the rate is limited by the minimum reactant (fuel or oxidizer) in the mixed composition of the cell which makes this formulation a mixing-controlled reaction.   

\subsection{Arrhenius Reaction}
There are conditions under which the local temperature and species concentrations support the computation of the reaction rate.  One set of conditions is where the reacting regions of the flow can be considered a well-stirred reactor.  The other is during a DNS calculation.  In the first case rather than a reacting surface, there is a reacting volume.  In the second case, the fine grid resolution enables the direct modeling of the diffusion of chemical species (fuel,
oxygen, and combustion products).  This allows the flame to be resolved in a DNS calculation.  Under conditions where the local gas
temperatures can be used to determine the reaction kinetics, Arrhenius rates can be used.


\subsection{Local Extinction}

\label{extinction}

The physical limitation of the mixing-controlled reaction model described in the previous section is that it assumes that fuel and oxygen burn instantaneously when mixed. For large-scale, well-ventilated
fires, this is a good assumption. However, if a fire is in an
under-ventilated compartment, or if a suppression agent like water
mist or CO$_2$ is introduced, or if the shear layer between fuel and oxidizing streams
has a sufficiently large local strain rate,
fuel and oxygen may mix but may not burn.
The physical mechanisms underlying these phenomena are complex, and
even simplified models still rely on an accurate prediction
of the flame temperature and local strain rate.
Subgrid-scale modeling of gas phase suppression and
extinction is still an area of active research in the combustion
community.

Simple empirical rules can be used to predict local
extinction based on the species and temperature present in the flame sheet.  The FDS extinction model consists of two parts. The first, checks to see if the local temperature is above an auto-ignition temperature for the fuel.  If the temperature is too low, then combustion will not occur.  Note that this temperature is by default set to absolute zero so that typical users do not need to specify an ignition source.  The second part the concept of a limiting flame temperature.  If the local combustion cannot raise the local temperature above the limiting flame temperature, then combustion will not occur. If either criteria is failed, then there is no chemical reaction and $\dot{m}^{\prime\prime\prime}_{\alpha}=0$. This is done in the following steps:

\begin{enumerate}
\item Search over all reactant species to find the limiting lumped species and express that species in terms of the reaction's fuel:

\be \Delta Z_F = \min_{i \; = \; reactant} \left(\frac{Z_i W_\F}{W_i \nu_i} \right) \ee
If fuel is the limiting reactant then $\Delta Z_F$ is the local fuel mass fraction. If the oxidizer is the limiting reactant then $\Delta Z_F$ is the mass fraction of fuel in stoichiometric proportion to oxidizer mass fraction.
\item Store $\Delta Z_F$, remove that amount of fuel from the local gas, and renormalize the mass fractions to account for the removal of fuel.
\item Search over all the updated non-fuel reactant species in the gas to determine the limiting reactant.  This defines how much air is required to burn the fuel:

\be \Delta Z_{Air} = \min_{i \; = \; non-fuel \; reactant} \left(\frac{\Delta Z_\F W_i \nu_i}{Z_i W_\F} \right) \ee
Note: $\Delta Z_{Air}$ is in stoichiometric proportion to $\Delta Z_{F}$.
\item Compute the enthalpy for the fuel and the air at both the current temperature and the limiting flame temperature.
\item Combustion is allowed if 

\be \Delta Z_{Air} h_{air}(T)+\Delta Z_F \left( h_\F(T)+\Delta H_\F \right) > \Delta Z_{Air} h_{air}(T_{LFT})+ \Delta Z_\F h_\F(T_{LFT}) \ee

\end{enumerate}

\section{Time Integration of Chemical Reactions}

\subsection{Single Step, Mixing-Controlled Reaction Rates}
For single-step chemical reactions with mixing-controlled reaction rates, an explicit Euler scheme is used to solve the system of ODEs that determine the chemical mass production rate, $\dot{m}^{\prime\prime\prime}_{\alpha}$. This is the default integration mechanism used in FDS.

\subsection{Other Chemistry Models}

For anything other than single step, mixing controlled chemistry a fourth-order explicit integrator with error control is used.  Since chemical timescales are often fast with respect to the hydrodynamic timescales, the solver uses subtimesteps during time integration of the chemical reactions to maintain the specified error tolerance.  Time integration is halted if no reactants are present or if the local heat release rate exceeds maximum allowable values.

More information on the numerical methods of the integrators can be found in Appendix~\ref{chemistry_integration}.

