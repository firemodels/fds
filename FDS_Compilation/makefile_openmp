# Makefile for Fire Dynamics Simulator (FDS), Version 5

# To use this makefile, select the appropriate compiler and OS from the list below. For example, to
# compile the 64 bit parallel version (MPI) of FDS under Linux with OpenMP using the Intel compilers type:
#
# make openmp_mpi_intel_linux_64

# The variable VPATH defines where the source code is relative to the current directory

VPATH = ../FDS_Source

# Definition of the non-MPI or MPI object variables

obj_serial = isob.o prec.o smvv.o cons.o devc.o type.o mesh.o func.o irad.o \
             ieva.o pois.o radi.o evac.o part.o vege.o ctrl.o turb.o dump.o hvac.o read.o \
             mass.o wall.o fire.o divg.o init.o velo.o pres.o mpis.o main.o
objwin_serial = $(obj_serial:.o=.obj)

obj_mpi = isob.o prec.o smvv.o cons.o devc.o type.o mesh.o func.o irad.o \
          ieva.o pois.o radi.o evac.o part.o vege.o ctrl.o turb.o dump.o hvac.o read.o \
          mass.o wall.o fire.o divg.o init.o velo.o pres.o mpip.o main.o
objwin_mpi = $(obj_mpi:.o=.obj)

# General Purpose Rules

no_target:
	@echo \******** You did not specify a make target \********
	@echo Please read the comments at the top of the makefile

setup:
%.o : %.mod

setup_win:
%.obj : %.mod

.SUFFIXES: .c .f90 .o .obj

# Files which have OpenMP compiler directives have to be compiled
# by using the FOPENMPFLAG
# read.f90 has to be compiled without optimization, otherwise 
# errors occure when reading .fds files.

func.o: FFLAGS += $(FOPENMPFLAGS)
part.o: FFLAGS += $(FOPENMPFLAGS)
turb.o: FFLAGS += $(FOPENMPFLAGS)
mass.o: FFLAGS += $(FOPENMPFLAGS)
fire.o: FFLAGS += $(FOPENMPFLAGS)
divg.o: FFLAGS += $(FOPENMPFLAGS)
velo.o: FFLAGS += $(FOPENMPFLAGS)
read.o: FOPTIMIZATIONFLAGS = -O0

func.obj: FFLAGS += $(FOPENMPFLAGS)
part.obj: FFLAGS += $(FOPENMPFLAGS)
turb.obj: FFLAGS += $(FOPENMPFLAGS)
mass.obj: FFLAGS += $(FOPENMPFLAGS)
fire.obj: FFLAGS += $(FOPENMPFLAGS)
divg.obj: FFLAGS += $(FOPENMPFLAGS)
velo.obj: FFLAGS += $(FOPENMPFLAGS)
read.obj: FOPTIMIZATIONFLAGS = -Od

.f90.o:
	$(FCOMPL) -c $(FOPTIMIZATIONFLAGS) $(FFLAGS) $<
.f90.obj:
	$(FCOMPL) -c $(FOPTIMIZATIONFLAGS) $(FFLAGS) $<
.c.o:
	$(CCOMPL) -c $(CFLAGS) $<
.c.obj:
	$(CCOMPL) -c $(CFLAGS) $<

#*** Compiler Specific Rules ***

# Windows Intel Compiler, version 11

 #*** note: the following scripts (located in ..\Scripts directory) must be run before running make with this target
 #    ..\Scripts\iclvars ia32
 #    ..\Scripts\ifortvars ia32

openmp_intel_win_32 : FFLAGS = /Qvec_report0
openmp_intel_win_32 : CFLAGS = -O2 -Dpp_noappend
openmp_intel_win_32 : FCOMPL = ifort
openmp_intel_win_32 : CCOMPL = icl
openmp_intel_win_32 : FOPENMPFLAGS = /Qopenmp /Qopenmp-link:static
openmp_intel_win_32 : FOPTIMIZATIONFLAGS = -O2
openmp_intel_win_32 : obj = fds5_openmp
openmp_intel_win_32 : setup_win $(objwin_serial)
	$(FCOMPL) -o $(obj) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) /F100000000 $(objwin_serial)

openmp_mpi_intel_win_32 : MPILIB = "c:\program files\mpich2\lib\fmpich2.lib"
openmp_mpi_intel_win_32 : MPIINCLUDE = "c:\program files\mpich2\include"
openmp_mpi_intel_win_32 : FFLAGS = /Qvec_report0 /I $(MPIINCLUDE) 
openmp_mpi_intel_win_32 : CFLAGS = -O2 -Dpp_noappend
openmp_mpi_intel_win_32 : FOPENMPFLAGS = /Qopenmp /Qopenmp-link:static
openmp_mpi_intel_win_32 : FOPTIMIZATIONFLAGS = -O2
openmp_mpi_intel_win_32 : FCOMPL = ifort
openmp_mpi_intel_win_32 : CCOMPL = icl
openmp_mpi_intel_win_32 : obj = fds5_openmp_mpi
openmp_mpi_intel_win_32 : setup_win $(objwin_mpi)
	$(FCOMPL) -o $(obj) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) /F100000000 $(objwin_mpi) $(MPILIB)

# Intel Compiler for Linux, version 11

openmp_intel_linux_32 : FFLAGS = -m32 -static -vec_report0
openmp_intel_linux_32 : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_intel_linux_32 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_32 : FOPTIMIZATIONFLAGS = -O3
openmp_intel_linux_32 : FCOMPL = ifort
openmp_intel_linux_32 : CCOMPL = icc
openmp_intel_linux_32 : obj = fds5_openmp_intel_linux_32
openmp_intel_linux_32 : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

### -check produces a runtime-error in the debug version
openmp_intel_linux_32_db : FFLAGS = -m32 -static -vec_report0 -warn unused -auto -WB -traceback -g -fltconsistency
openmp_intel_linux_32_db : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_intel_linux_32_db : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_32_db : FOPTIMIZATIONFLAGS = -O0
openmp_intel_linux_32_db : FCOMPL = ifort
openmp_intel_linux_32_db : CCOMPL = icc
openmp_intel_linux_32_db : obj = fds5_openmp_intel_linux_32_db
openmp_intel_linux_32_db : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_intel_linux_32_tcheck : FFLAGS = -m32 -g
openmp_intel_linux_32_tcheck : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_intel_linux_32_tcheck : FOPENMPFLAGS = -openmp -tcheck 
openmp_intel_linux_32_tcheck : FOPTIMIZATIONFLAGS = -O0
openmp_intel_linux_32_tcheck : FCOMPL = ifort
openmp_intel_linux_32_tcheck : CCOMPL = icc
openmp_intel_linux_32_tcheck : obj = fds5_openmp_intel_linux_32_tcheck
openmp_intel_linux_32_tcheck : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_mpi_intel_linux_32 : FFLAGS = -m32 -vec_report0
openmp_mpi_intel_linux_32 : CFLAGS = -m32 -O -Dpp_noappend -vec_report0
openmp_mpi_intel_linux_32 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_mpi_intel_linux_32 : FOPTIMIZATIONFLAGS = -O3
openmp_mpi_intel_linux_32 : FCOMPL = mpif90 -fc=ifort
openmp_mpi_intel_linux_32 : CCOMPL = icc
openmp_mpi_intel_linux_32 : obj = fds5_openmp_mpi_intel_linux_32
openmp_mpi_intel_linux_32 : setup $(obj_mpi)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi)

openmp_intel_linux_64 : FFLAGS = -m64 -static -vec_report0
openmp_intel_linux_64 : CFLAGS = -m64 -O -Dpp_noappend -vec_report0
openmp_intel_linux_64 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_64 : FOPTIMIZATIONFLAGS = -O3
openmp_intel_linux_64 : FCOMPL = ifort
openmp_intel_linux_64 : CCOMPL = icc
openmp_intel_linux_64 : obj = fds5_openmp_intel_linux_64
openmp_intel_linux_64 : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

### -check produces a runtime-error in the debug version
openmp_intel_linux_64_db : FFLAGS = -m64 -static -vec_report0 -warn unused -auto -WB -traceback -g -fltconsistency
openmp_intel_linux_64_db : CFLAGS = -m64 -O0 -Dpp_noappend -vec_report0
openmp_intel_linux_64_db : FOPENMPFLAGS = -openmp -openmp-link static
openmp_intel_linux_64_db : FOPTIMIZATIONFLAGS = -O0
openmp_intel_linux_64_db : FCOMPL = ifort
openmp_intel_linux_64_db : CCOMPL = icc
openmp_intel_linux_64_db : obj = fds5_openmp_intel_linux_64_db
openmp_intel_linux_64_db : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_intel_linux_64_tcheck : FFLAGS = -m64 -g
openmp_intel_linux_64_tcheck : CFLAGS = -m64 -O -Dpp_noappend -vec_report0
openmp_intel_linux_64_tcheck : FOPENMPFLAGS = -openmp -tcheck
openmp_intel_linux_64_tcheck : FOPTIMIZATIONFLAGS = -O0
openmp_intel_linux_64_tcheck : FCOMPL = ifort
openmp_intel_linux_64_tcheck : CCOMPL = icc
openmp_intel_linux_64_tcheck : obj = fds5_openmp_intel_linux_64_tcheck
openmp_intel_linux_64_tcheck : setup $(obj_serial)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_serial)

openmp_mpi_intel_linux_64 : FFLAGS = -m64 -vec_report0
openmp_mpi_intel_linux_64 : CFLAGS = -m64 -O -Dpp_noappend -vec_report0
openmp_mpi_intel_linux_64 : FOPENMPFLAGS = -openmp -openmp-link static
openmp_mpi_intel_linux_64 : FOPTIMIZATIONFLAGS = -O3
openmp_mpi_intel_linux_64 : FCOMPL = mpif90 -fc=ifort
openmp_mpi_intel_linux_64 : CCOMPL = icc
openmp_mpi_intel_linux_64 : obj = fds5_openmp_mpi_intel_linux_64
openmp_mpi_intel_linux_64 : setup $(obj_mpi)
	$(FCOMPL) $(FOPTIMIZATIONFLAGS) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi)

#*** End Compiler Specific Rules ***

# *** Object Dependencies ***

smvv.o : isob.o
cons.o : prec.o
type.o : prec.o cons.o
devc.o : prec.o
pois.o : prec.o
mesh.o : prec.o type.o
func.o : prec.o cons.o type.o mesh.o
turb.o : func.o prec.o cons.o mesh.o
ctrl.o : prec.o cons.o type.o mesh.o func.o
irad.o : func.o prec.o cons.o type.o mesh.o
ieva.o : func.o prec.o cons.o type.o mesh.o
fire.o : func.o prec.o cons.o type.o mesh.o
wall.o : func.o prec.o cons.o type.o mesh.o
velo.o : func.o prec.o cons.o type.o mesh.o turb.o
divg.o : func.o prec.o cons.o type.o mesh.o
mass.o : func.o prec.o cons.o type.o mesh.o turb.o
radi.o : func.o prec.o cons.o type.o mesh.o irad.o
evac.o : func.o prec.o cons.o type.o mesh.o ieva.o
pres.o : func.o prec.o cons.o type.o mesh.o pois.o velo.o
part.o : func.o prec.o cons.o type.o mesh.o devc.o
vege.o : func.o prec.o cons.o type.o mesh.o devc.o part.o
hvac.o : func.o prec.o cons.o type.o mesh.o ctrl.o
read.o : func.o prec.o cons.o type.o mesh.o devc.o irad.o evac.o hvac.o
init.o : func.o prec.o cons.o type.o mesh.o devc.o irad.o pois.o
dump.o : func.o prec.o cons.o type.o mesh.o devc.o evac.o smvv.o isob.c turb.o
main.o : func.o prec.o cons.o type.o mesh.o devc.o smvv.o isob.c mass.o divg.o velo.o wall.o fire.o irad.o ieva.o radi.o evac.o part.o vege.o dump.o read.o init.o pres.o pois.o ctrl.o turb.o hvac.o

smvv.obj : isob.obj
cons.obj : prec.obj
type.obj : prec.obj cons.obj
devc.obj : prec.obj
pois.obj : prec.obj
mesh.obj : prec.obj type.obj
func.obj : prec.obj cons.obj type.obj mesh.obj
turb.obj : func.obj prec.obj cons.obj mesh.obj
ctrl.obj : prec.obj cons.obj type.obj mesh.obj func.obj
irad.obj : func.obj prec.obj cons.obj type.obj mesh.obj
ieva.obj : func.obj prec.obj cons.obj type.obj mesh.obj
fire.obj : func.obj prec.obj cons.obj type.obj mesh.obj
wall.obj : func.obj prec.obj cons.obj type.obj mesh.obj
velo.obj : func.obj prec.obj cons.obj type.obj mesh.obj turb.obj
divg.obj : func.obj prec.obj cons.obj type.obj mesh.obj
mass.obj : func.obj prec.obj cons.obj type.obj mesh.obj turb.obj
radi.obj : func.obj prec.obj cons.obj type.obj mesh.obj irad.obj
evac.obj : func.obj prec.obj cons.obj type.obj mesh.obj ieva.obj
pres.obj : func.obj prec.obj cons.obj type.obj mesh.obj pois.obj velo.obj
part.obj : func.obj prec.obj cons.obj type.obj mesh.obj devc.obj
vege.obj : func.obj prec.obj cons.obj type.obj mesh.obj devc.obj part.obj
hvac.obj : func.obj prec.obj cons.obj type.obj mesh.obj ctrl.obj
read.obj : func.obj prec.obj cons.obj type.obj mesh.obj devc.obj ctrl.obj irad.obj evac.obj hvac.obj
init.obj : func.obj prec.obj cons.obj type.obj mesh.obj devc.obj irad.obj pois.obj
dump.obj : func.obj prec.obj cons.obj type.obj mesh.obj devc.obj evac.obj smvv.obj isob.c turb.obj
main.obj : func.obj prec.obj cons.obj type.obj mesh.obj devc.obj smvv.obj isob.c mass.obj divg.obj velo.obj wall.obj fire.obj irad.obj ieva.obj radi.obj evac.obj part.obj vege.obj dump.obj read.obj init.obj pres.obj pois.obj ctrl.obj turb.obj


#*** Clean Target to remove Object and Module files ***

.PHONY : clean
clean:
	-rm -f *.o *.mod *.obj 

.PHONY : winclean
winclean:
	-erase *.mod *.obj 
