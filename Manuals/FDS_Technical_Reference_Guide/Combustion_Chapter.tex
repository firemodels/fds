\chapter{Combustion (Chemically Reacting Flows)}
\label{chapter:combustion}

\label{combustionsection}
The combustion routine is responsible for determining the mean chemical mass production rate of species $\alpha$ per unit volume, $\dot{m}^{\prime\prime\prime}_{\alpha}$ in the species transport equation, Eq.~(\ref{species}). In this chapter, we integrate the change in species concentration over a time step for a single grid cell to obtain the mean chemical source term,
\begin{equation}\label{eq:m_tprime_alpha}
\dot{m}^{\prime\prime\prime}_{\alpha}=\rho \,\frac{Y_\alpha(\delta t) - Y_\alpha(0)}{\delta t}
\end{equation}
The integration of the mean chemical source term is time split from the integration of the transport equation such that each cell may be thought of as a partially-stirred batch reactor.  As we discuss below, given the chemical composition, cell temperature, and extent of mixing at the start of the time step, the final cell composition depends on the rates of chemical kinetics and turbulent mixing.

The combustion routine also returns the heat release for per unit volume, $\dot{q}^{\prime\prime\prime}$, a quantity of fundamental importance in fire dynamics and typically the largest contribution to the flow divergence, Eq.~(\ref{eqn_fdsD1}).  The heat release rate is found by summing the lumped species mass production rates times their respective heats of formation:
\begin{equation}\label{eq:q_tprime}
\dot{q}^{\prime\prime\prime} \equiv -\displaystyle \sum_{\alpha} \dot{m}_\alpha^{\prime\prime\prime} \Delta H_{f,\alpha}
\end{equation}

The remainder of this chapter consists of three main topics.  The first is a discussion of our ``lumped species'' approach, which aims to reduce the computational burden of the full chemical system by combining species into groups that transport and react together.  Next, we discuss our approach to describing the chemical mixing process.  We treat each computational cell as a partially-stirred batch reactor with a characteristic mixing time.  The model for the mixing time is discussed.  Once reactants are mixed, the reaction rate depends on kinetics.  The last part of this chapter discusses available kinetic mechanisms within FDS, from infinitely fast chemistry (default) to Arrhenius rate laws and reversible reactions.

\section{Lumped Species Approach}
In the typical FDS problem we consider the simple reaction:
\begin{equation}\label{eq:simple}
\mathrm{Fuel + Air \rightarrow Products}
\end{equation}
We refer to the Fuel, Air, and Products as \emph{lumped species}.  The lumped species approach is a simplified reaction progress variable approach \cite{fox2003} in which all the progress variables behave as mass fractions. This avoids the complications related to boundedness and ill-defined initial and boundary conditions in the traditional approach.

In a simple hydrocarbon reaction, the reactants are the fuel, oxygen, and nitrogen and the products are carbon dioxide, water vapor, and nitrogen. The primitive species mass fractions are given by the composition vector
\begin{equation}\label{eq:prim_vector}
\mathbf{Y} = [Y_{\mathrm{CH}_4}\, \, Y_{\mathrm{O}_2}\, \, Y_{\mathrm{N}_4}\, \, Y_{\mathrm{CO}_2}\, \, Y_{\mathrm{H}_2\mathrm{O}}]^T
\end{equation}
Lumped species are groups of primitive species which only exist in the flow in certain proportions. For example, ``Air'' can be assumed to be a lumped species composed of 21\% O$_2$ and 79\% N$_2$ by volume. The key assumption made in lumping primitive species is that the new species groups transport (implying equal diffusivities) and react together. 

We can expand Eq.~(\ref{eq:simple}) to show the components of the lumped species for a simple, one-step methane reaction. 
\begin{equation}\label{eq:lumped_expand}
\mathrm{2\underbrace{(\mbox{O}_2+(.79/.21)\mbox{N}_2)}_\text{Background,~$Z_0$}+\underbrace{\mbox{CH}_4}_\text{Fuel,~$Z_1$} \rightarrow 1\underbrace{(\mbox{CO}_2+2\mbox{H}_2\mbox{O}+2(.79/.21)\mbox{N}_2)}_\text{Products,~$Z_2$}}
\end{equation}
As described by Eq.~(\ref{eq:lumped_expand}), two moles of the lumped species ``Background'' react with one mole of lumped species ``Fuel'', to produce one mole of lumped species ``Products''. In FDS, the background species is not transported but solved for since the sum of the mass fractions of the lumped species must be unity. Lumped species are defined by the vector $\textbf{Z}$ which is indexed from $0:N_{z}$ by the Roman numeral $i$. This means that $N_{z}$ transport equations are solved. In the case of Eq.~(\ref{eq:lumped_expand}), two transport equations are solved (fuel and products) which is the same number solved in the mixture fraction progress variable approach.

The linear transformation from lumped species to primitive species is given by: 
\begin{equation}\label{eq:transform}
\textbf{Y}=A\textbf{Z} 
\end{equation}
where $A$ is the transformation matrix ($N_{y}$ rows $\times$ $(N_{z}+1)$ columns).  Each column of $A$ represents a different lumped species.  The elements of $A$ are the mass fractions for each primitive species in a given lumped species:
\begin{equation}\label{eq:A_def}
A_{\alpha\,i} = \frac{\upsilon_{\alpha\,i}W_{\alpha}}{\displaystyle \sum_{\alpha}\upsilon_{\alpha i}W_{\alpha}}
\end{equation}
where $\upsilon_{\alpha\,i}$ are the volume ratios of primitive species $\alpha$ in lumped species $i$.

If we want the primitive species in Eq.~(\ref{eq:lumped_expand}) and, as an example, say we have $\mathbf{Z} = [0.3 \,\,\, 0.2 \,\,\, 0.5]^T$, we can transform from lumped species to primitive species via

\begin{equation}\label{eq:transform_to_primitive}
\mathbf{Y}=\left[\begin{array}{c}
       Y_{O_2} \\
       Y_{N_2} \\
       Y_{CH_4} \\
       Y_{CO_2} \\
       Y_{H_2O} \\
     \end{array}\right]
     =\left[\begin{array}{ccc}
     0.2330 & 0 & 0 \\
     0.7670 & 0 & 0.7248 \\
     0 & 1 & 0 \\
     0 & 0 & 0.1514 \\
     0 & 0 & 0.1238 \\
     \end{array}\right]
     \left[\begin{array}{c}
     0.3 \\
     0.2 \\
     0.5 \\
     \end{array}\right]
     =\left[\begin{array}{c}
     0.0699\\
     0.5925\\
     0.2000\\
     0.0757\\
     0.0619\\
     \end{array}\right]
\end{equation}
To transform back to lumped species from primitive species we can use:
\begin{equation}\label{eq:transform_back}
\textbf{Z}=B\textbf{Y} \quad ; \quad B=(A^TA)^{-1}A^T
\end{equation}

\subsection{Simple Chemistry}

The default reaction system in FDS is fuel plus oxidizer goes to products, where the products are carbon dioxide, water vapor, nitrogen, carbon monoxide, and soot. For a typical hydrocarbon fuel, the chemical reaction in FDS follows
\begin{multline}\label{eq:full_lump}
\nu_{0}\underbrace{(\upsilon_{\mathrm{O}_{2},0}\mathrm{O}_2 \upsilon_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\upsilon_{\mathrm{CO}_{2},0}\mathrm{CO}_2+\upsilon_{\mathrm{N}_{2},0}\mathrm{N}_2)}_\text{Background,~$Z_0$} \,\,+ \,\, \nu_{1}\underbrace{\mbox{C}_m\mbox{H}_n\mbox{O}_a\mbox{N}_b}_\text{Fuel,~$Z_1$} \quad \longrightarrow \\
\nu_{2}\underbrace{(\upsilon_{\mathrm{CO}_{2},2}\mathrm{CO}_2+\upsilon_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\upsilon_{\mathrm{N}_{2},0}\mathrm{N}_2+\upsilon_{\mathrm{CO},2}\mathrm{CO}+\upsilon_{\mathrm{S},2}\mathrm{S})}_\text{Products,~$Z_2$}
\end{multline}
Here the volume fraction of primitive species $\alpha$ in lumped species $i$ is denoted by $\upsilon_{\alpha\,i}$ and the stoichiometric coefficients for the lumped species $i$ are denoted by $\nu_{i}$.

\subsection{Specified CO and Soot Yield}

Carbon monoxide and soot yields are zero by default. The user can specify the CO and soot yields ($y_{\mathrm{CO}}$ and $y_{\mathrm{S}}$ respectively) on the {\ct REAC} line; this determines the composition of the products. In this reaction system, Air (Background) is lumped species 0, Fuel is lumped species 1, and Products is lumped species 2. To find the stoichiometric coefficients of CO and soot within the products lumped species, FDS uses
\begin{eqnarray}\label{eq:yields}
\nu_{2}\upsilon_{\mathrm{CO},2}&=&-\nu_{1}\frac{W_1}{W_{\mathrm{CO}}}y_{\mathrm{CO}} \\
\nu_{2}\upsilon_{\mathrm{S},2}&=&-\nu_{1}\frac{W_1}{W_{\mathrm{S}}}y_{\mathrm{S}}
\end{eqnarray}
The remaining coefficients come from an atom balance.

Consider a methane--air reaction where methane has a specified CO yield of $y_{\mathrm{CO}}=0.1$ and a Soot yield of $y_{\mathrm{S}}=0.01$. The default FDS reaction system lumps these species into the products. Note that, by default, air is primarily composed of oxygen and nitrogen but includes trace amounts of carbon dioxide and water vapor. For this reaction the transformation matrix, $A$, is

\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline  & Air & Fuel & Products \\ \hline \hline
{CH$_4$}           & 0.000000 & 1.000000 & 0.000000 \\
{N$_2$}            & 0.763017 & 0.000000 & 0.720373 \\
{O$_2$}            & 0.231163 & 0.000000 & 0.000000 \\
{CO$_2$}           & 0.000592 & 0.000000 & 0.143067 \\
{CO}               & 0.000000 & 0.000000 & 0.005589 \\ 
{H$_2$O}           & 0.005228 & 0.000000 & 0.130412 \\
{C}                & 0.000000 & 0.000000 & 0.000559 \\ \hline
\end{tabular}
\end{center}

\noindent The preceding table shows that the addition of carbon monoxide and soot increases the number of primitive species in the reaction from five to seven. The number of lumped species, however, remains at three---the composition of products has changed to include to the two additional species.


\subsection{Primitive Species}

\subsubsection{Tracking Select Species (Such as Evaporating Droplets)}

There are cases where tracking a particular primitive species is needed, such as water droplet evaporation or complex chemical reactions. In sprinkler nozzle cases, for example, there is water vapor that is produced by fuel combustion that lives in the products lumped species and there is water vapor that is produced from liquid water droplet evaporation. The evaporated water vapor cannot simply be added to the lumped species, because, by definition, the primitive species fraction within a given lumped species cannot change. As a result, the evaporated water vapor must be transported as its own lumped species.  If the local primitive species concentration of water vapor is needed, it may be obtained using the transformation in Eq.~(\ref{eq:transform_to_primitive}).   

\subsubsection{Tracking All Species}

If we revisit Eq.~(\ref{eq:full_lump}) but decompose the reaction into all primitive species, we get:
\begin{multline}\label{eq:prim}
\nu_{\mathrm{O}_{2},0}\mathrm{O}_2+\nu_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\nu_{\mathrm{CO}_{2},0}\mathrm{CO}_2+\nu_{\mathrm{N}_{2},0}\mathrm{N}_2+\nu_{\mathrm{fuel},0}(\mbox{C}_m\mbox{H}_n\mbox{O}_a\mbox{N}_b) \longrightarrow \\
\nu_{\mathrm{CO}_{2},2}\mathrm{CO}_2+\nu_{\mathrm{H}_{2}\mathrm{O},0}\mathrm{H}_2\mathrm{O}+\nu_{\mathrm{N}_{2},0}\mathrm{N}_2+\nu_{\mathrm{CO},2}\mathrm{CO}+\nu_{\mathrm{S},2}\mathrm{S}
\end{multline}
In this formulation, we would have to solve transport equations for six species, as compared to two when the species are lumped. Note that in cases with all primitive species, $A$ becomes the identity matrix.

%\begin{center}
%\begin{tabular}{|c|c|c|c|c|c|c|c|}
%\hline  & {CH$_4$} & {N$_2$} & {O$_2$} & {CO$_2$} & {CO} & {H$_2$O} & {C} \\ \hline \hline
%{CH$_4$}            & 1.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\
%{N$_2$}             & 0.00 & 1.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\
%{O$_2$}             & 0.00 & 0.00 & 1.00 & 0.00 & 0.00 & 0.00 & 0.00 \\
%{CO$_2$}            & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 & 0.00 & 0.00 \\
%{CO}                & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 & 0.00 \\ 
%{H$_2$O}            & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 \\ 
%{C}                 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 \\\hline
%\end{tabular}
%\end{center}
For cases that explicitly track all of the primitive species, FDS could end up solving upwards of 10-20 transport equations depending on the case, with each additional tracked species adding roughly 5\% to the computational cost.



\section{Turbulent Combustion}

Modeling chemical reactions in turbulent flow is mathematically challenging because the length and time scales associated with the reactions may be orders of magnitude below what can be spatially and temporally resolved by the simulation. To address these difficulties, FDS employs a simple mixing environment method to close the mean chemical source term, $\dot{m}^{\prime\prime\prime}_{\alpha}$, in Eq.~(\ref{species}).  As we will show below, for pure diffusion flames our method is similar to the Eddy Dissipation Concept (EDC) \cite{Magnussen:1}. Each computational cell is thought of as a batch reactor with two environments: the mean concentration of species, which FDS transports, and the amount of mixing within the reactor, which we model. At the start of an FDS time step, each cell has an initial concentration of species (reactants, products, inerts) that exist with some degree of mixing. By default, each cell is completely unmixed at the start of a time step (corresponding to a diffusion flame). Generally, the rate of mixing is dominated by turbulence.  The mixing time, $\tau_{mix}$, is discussed in Section \ref{sec:reac_time_scale}. Section \ref{sec:EDC} discusses the model that couples mixing and chemical reactions. Once mixed, species can react based on specified kinetic parameters---reactions may be infinitely fast or governed by an Arrhenius rate law (Section \ref{Reaction_Rate_Model}). 


\subsection{Partially-Stirred Batch Reactor Model}
\label{sec:EDC}

At the start of the integration of the reactor model, the species transport equations have been solved and we know the mean cell concentrations of all reactants in our chemical system.  In this section, we will work in terms of primitive species mass fractions, $Y_\alpha$.  The cell mean is denoted $\overline{Y}_\alpha(t)$ and is a function of time.

\subsubsection{Transport Versus Mixing}

In turbulent combustion, \emph{transport} and \emph{mixing} may be easily confused.  It is especially important to distinguish these phenomena when considering infinitely fast chemistry, because in that case it is mixing (not transport) that dictates the rate of reaction.

FDS employs a \emph{time splitting} scheme (Sections \ref{sec:solution_procedure} and \ref{sec_time_splitting}) to solve the species equations in which we first compute transport (both advective and diffusive) and then we compute mixing.  Note that transport due to turbulent diffusion does not mix the chemical species.  This is illustrated in Fig.~\ref{fig_transport_vs_mixing}.  On the far left, we show a hypothetical computational cell at the end of the transport step and the beginning of the mixing and reaction step in our algorithm.  Notice that there is a subgrid distribution of the species mass fraction.  Locally in space the mass fraction may be pure fuel or pure oxidizer.  In this image, where there are already various shades of gray, it may be noted that  the initial condition of the cell may not be purely unmixed.  As we proceed to the right in our image sequence, the local cell composition is relaxing toward the mean value of 0.5. 

\begin{figure}[h]
\centering
\includegraphics[width=1.6in]{FIGURES/transport_vs_mixing_1} \quad 
\includegraphics[width=1.6in]{FIGURES/transport_vs_mixing_2} \quad
\includegraphics[width=1.6in]{FIGURES/transport_vs_mixing_3} \quad
\includegraphics[height=1.6in]{FIGURES/transport_vs_mixing_colorbar}
\caption{Subgrid-scale transport and mixing. The image sequence depicts a hypothetical computational cell with mean mass fraction 0.5 and, from left to right, increasing levels of mixing.}
\label{fig_transport_vs_mixing}
\end{figure}

\subsubsection{The Interaction by Exchange with the Mean (IEM) Mixing Model}

The simplest possible mixing model is the interaction by exchange with the mean (IEM) model.  IEM states that, in the abscense of chemical reaction, the local mass fractions obey the following ODE:
\begin{equation}\label{eq:iem}
\frac{\mbox{d}Y_\alpha}{\mbox{d}t} = \frac{1}{\tau_{mix}}(\overline{Y}_\alpha - Y_\alpha)
\end{equation}
where $\tau_{mix}$ is the characteristic mixing time for the cell.  This time scale is discussed below in Section \ref{sec:reac_time_scale}.  For now, simply note that small values of $\tau_{mix}$ correspond to high turbulence intensity (fast mixing) and visa versa.

\subsubsection{A Simplified Mixing Environment}

In our model, the local concentration at any point within the cell exists in one of two states: completely unmixed or completely mixed.  With $\psi_\alpha \in [0,1]$ representing the sample space for the composition, the subgrid probability density function (PDF) may be written as
\begin{equation}
\label{eq:pdf}
f(\psi_\alpha) = w_1 \delta(0-\psi_\alpha) + w_2 \delta(1-\psi_\alpha) + w_3 \delta(\overline{Y}_\alpha - \psi_\alpha)
\end{equation}
where $\delta(x)$ is the Dirac delta function.  In other words, if we look at a specific point in space, the mass fraction of species $\alpha$ may only be 0, 1, or equal to the cell mean, $\overline{Y}_\alpha$.  The weights $w_i$ must satisfy integral constraints on the cell: $\int f(\psi_\alpha) \d \psi_\alpha = 1$, $\int f(\psi_\alpha) \psi_\alpha \d \psi_\alpha = \overline{Y}_\alpha$.

For convenience (we will see why it is convenient in a moment), we define the \emph{unmixed} fraction, $\zeta(t)$, as the fraction of the cell existing as either 0 or 1.  To satisfy the integral constraints, the PDF weights must then be
\begin{align}
w_1 &= \zeta \, (1 - \overline{Y}_\alpha) \\
w_2 &= \zeta \, \overline{Y}_\alpha \\
w_3 &= 1-\zeta
\end{align}

As shown by Pope \cite{Pope:2000}, the PDF evolves by the Fokker-Planck equation
\begin{equation}
\label{eq:fokker-planck}
\frac{\partial f}{\partial t} = -\frac{\partial}{\partial \psi_\alpha} \left(f \left\langle \left. \frac{\partial Y_\alpha}{\partial t} \right| \psi_\alpha \right\rangle \right)
\end{equation}
The term on the right in angled brackets is a conditional diffusion term which requires closure.  Using IEM, Eq.~(\ref{eq:iem}), as the model for this term, Eq.~(\ref{eq:fokker-planck}) implies that the unmixed fraction, $\zeta$, is governed by the following simple ODE\footnote{This is a good exercise for the reader.  Hint: Just consider the evolution of the second term in Eq.~(\ref{eq:pdf}) and utilize Appendix C in Pope \cite{Pope:2000}.}:
\begin{equation}\label{eq:zeta}
\frac{\mbox{d}\zeta}{\mbox{d}t}=-\frac{\zeta}{\tau_{mix}}
\end{equation}
with the solution
\begin{equation}\label{eq:zeta_soln}
\zeta(t) = \zeta_0 \exp(-t/\tau_{mix})
\end{equation}

We may think of an initial unmixed fraction of $\zeta_0=1$ (default) as representing a diffusion flame and $\zeta_0=0$ as a premixed flame.

%\begin{equation}\label{eq:zeta_def}
%\zeta \equiv \frac{\displaystyle \sum_{\alpha}(\psi_{\alpha}- \langle \psi_{\alpha} \rangle )}{n_{\alpha} - 1}
%\end{equation}

\subsubsection{Evolution of the Composition in the Mixed Reactor Zone}

As just discussed, the present reactor model partitions the cell into two zones: an unmixed zone and a mixed zone.  Only the mixed zone may react chemically.  Our goal in this section is to describe the rate of change of the composition within the mixed zone.  This composition changes by two processes: mixing (mass is transfered from the unmixed zone to the mixed zone) and chemical reaction.  The mixed zone composition evolves in time over an FDS time step, $\delta t$.  At the end of the time step, the mixed and unmixed zones are then recombined to yield the final cell mean composition, $\overline{Y}_\alpha(\delta t)$.

The total mass within the reactor (computational cell) is constant over the time step.  We denote this mass by $\rho V$, where $\rho$ is the initial cell mass density and $V$ is the cell volume.  The unmixed mass is denoted $U(t)$ and the mixed mass is denoted $M(t)$.  Given Eq.~(\ref{eq:zeta_soln}), the following equations describe the cell mass evolution:
\begin{eqnarray}
\label{eq:mixunmix_1} \rho V &=& U(t) + M(t) \\
\label{eq:mixunmix_2} U(t) &=& \zeta(t)\,\rho V \\
\label{eq:mixunmix_3} M(t) &=& (1-\zeta(t))\,\rho V
\end{eqnarray} 

Within the mixed reactor zone, let $m_\alpha(t)$ denote the mass of species $\alpha$.  The mass fraction of $\alpha$ in the mixed zone is denoted by
\begin{equation}\label{eq:mass_fraction_mixed}
\hat{Y}_{\alpha}(t)\equiv\frac{m_{\alpha}(t)}{M(t)}
\end{equation}
This concentration is important because any Arrhenius rate equations (discussed below) will be based on the mixed composition only.

The ODE governing the mixed species mass is
\begin{equation}\label{eq:mixmass}
\frac{\d m_{\alpha}}{\d t} = M \frac{\d \hat{Y}_\alpha}{\d t} + \hat{Y}_\alpha \frac{\d M}{\d t} = M \frac{\d \hat{Y}_\alpha}{\d t} - \overline{Y}_{\alpha,0} \frac{\d U}{\d t}
\end{equation}
The first term on the RHS represents chemical kinetics.  The second term accounts for mixing.  Note that in the second step we have utilized the fact that the ummixed composition remains constant (at the initial cell mean) throughout the time step. Using Eqs.~(\ref{eq:zeta}) and (\ref{eq:mixunmix_2}), the second term becomes
\begin{align}
-\overline{Y}_{\alpha,0} \frac{\d U}{\d t} &= \frac{\overline{Y}_{\alpha,0} \, U(t) }{\tau_{mix}}
\end{align}

The rate of reaction, $\d \hat{Y}_\alpha/\d t$, is discussed in Section \ref{Reaction_Rate_Model}. The reaction rate may be ``fast'' (default) or based on an Arrhenius rate law.  The integration of Eq.~(\ref{eq:mixmass}) for these special cases is discussed in Section \ref{sec:reac_time_integration}.

Once the final mixed zone mass is known, the composition of the computational cell is found by recombining the unmixed and mixed portions:
\begin{equation}\label{eq:final_comp}
\overline{Y}_{\alpha}(\delta t)= \zeta(\delta t) \, \overline{Y}_{\alpha,0} + (1-\zeta(\delta t)) \, \hat{Y}_{\alpha}(\delta t)
\end{equation}
Finally, the mean chemical source term needed in Eq.~(\ref{eq:mass_source_terms}) is given by
\begin{equation}\label{mass_prod_rate}
\dot{m}^{\prime\prime\prime}_{\alpha} = \rho \frac{\overline{Y}_{\alpha}(\delta t) - \overline{Y}_{\alpha,0}}{\delta t}
\end{equation}

\subsubsection{A Limiting Case: The Eddy Dissipation Concept}

For the special case where the initial unmixed fraction is set to unity and the chemical kinetics are taken to be infinitely fast, our model reduces to the eddy dissipation concept (EDC) model as presented in \cite{Poinsot:TNC}.

\subsubsection{Future Work}

Discussion on the extension of the partially-stirred reactor model to include multiple environments as a way to determine the initial unmixed fraction (as opposed to specifying it, as we do currently) is included in Appendix~{\ref{multi_env_edc}}.

\subsection{Reaction Time Scale Model}
\label{sec:reac_time_scale}

In the fast chemistry limit, our task is to provide an expression for the mixing time based on the local state of the flow field.  The basic idea behind the model we propose here is to consider the three physical processes of diffusion, subgrid-scale (SGS) advection, and buoyant acceleration and to take the fastest of these processes (locally) as the controlling flow time scale.

It is important to consider the behavior of a model as the filter width varies. The mixing times for diffusion, SGS advection, and buoyant acceleration scale differently with filter width and if we look to the limits of the filter scales an interesting picture emerges.  Referring to Fig.~\ref{fig_reaction_time_scale}, let us move from left to right along the horizontal axis following the thick black line which represents our time scale model for a hypothetical flow condition.  First, notice that the reaction time scale must be greater than or equal to the chemical time scale, $\tau_{chem}$, which, though small, is finite. At a slightly larger scale we expect the mixing time to vary as the square of the filter width because the mixing is controlled by molecular diffusion.  In this regime, denoted $\tau_d$, the numerical solution is a DNS and this scaling law is valid while $\Delta$ is less than the Kolmogorov scale, $\eta$, the length scale of the smallest turbulent eddies. For a sufficiently high Reynolds number flow (such that an inertial subrange exists), as the filter width increases beyond the Kolmogorov scale we encounter a regime, marked $\tau_u$, where turbulent advection controls the rate of mixing and the mixing time varies as the two thirds power of the filter width \cite{Pope:2000}.  This is the regime where most LES submodels are valid.

Now let us imagine what should happen to the mixing time as the filter width increases beyond the inertial subrange to a length scale larger than the height of the flame itself (actually a possibility in wildfire modeling). We would \emph{not} expect the inertial range scaling to continue up through the so-called ``energy-containing'' range of turbulent length scales.  Rather, for fires--which are generally buoyancy-driven flows--we expect buoyant acceleration to control the mixing at these relatively coarse scales.  A time scale based on a constant acceleration goes as the square root of the filter width, as shown by the regime marked $\tau_g$ in the diagram.  This shift in scaling may appear minor given the log-log nature of the plot, but the effect of the acceleration-based time scale is indeed significant for large cell sizes.  Finally, note that the flame height presents a limit to the reaction time scale, here denoted $\tau_{flame}$, since all fuel must be consumed within a single cell.

\begin{figure}[t]
\centering
\includegraphics[width=4.5in]{FIGURES/reaction_time_scale.pdf}
\vskip-.2cm
\caption{Reaction time scale model.}
\label{fig_reaction_time_scale}
\end{figure}

Of course, the relative importance of the physical processes will depend on the flow.  For example, if gravity is weak the $\tau_g$ line shifts up and may not affect the reaction time before the flame time scale is reached.  If the flow is highly turbulent, the inertial range scaling may be more dominant, which would be indicated by a lowering of the $\tau_u$ line.  Or, for highly turbulent jet flames $\tau_{flame}$ may be reached before the acceleration time scale has any effect.  Perhaps more typical for low strain fires, if an inertial subrange does not exist (if the Reynolds number is too low relative to the Froude number), then the $\tau_u$ line in Fig.~\ref{fig_reaction_time_scale} moves up out of the picture and we are left with diffusion and buoyancy to control the mixing.

The bold solid line in Fig.~\ref{fig_reaction_time_scale} is mathematically represented by
\begin{equation}
\label{eqn_tau_mix}
\tau_{mix} = \max(\tau_{chem},\min(\tau_d,\tau_u,\tau_g,\tau_{flame}))
\end{equation}
The mathematical details of the submodels are as follows:
\begin{align}
\label{eq:tau_diff} \tau_{d} &= \frac{\Delta^2}{D_F} \\
\label{eq:tau_sgs}  \tau_{u} &= \frac{\Delta}{\sqrt{2k_{sgs}}} \\
\label{eqn_tau_grav}\tau_{g} &= \sqrt{ 2\Delta/g }
\end{align}
where $D_F$ is the diffusivity of the fuel species. Note that $k_{sgs}$ is the unclosed subgrid kinetic energy per unit mass which by default is take from the model for the turbulent viscosity (see Section \ref{section:turbulent_viscosity}). The acceleration time scale $\tau_{g}$ is the time required to travel a distance $\Delta$ starting from rest under a constant acceleration, $g=9.81$ m/s$^2$.

\subsection{Heat Release Rate}

Each chemical reaction in FDS must be defined with a fuel and sufficient information such that a heat of formation is known for each participating species. The heat release per unit volume is found by summing the species mass production rates by the respective species heat of formation:
\begin{equation}\label{eq:vol_heat_gen}
\dot{q}^{\prime\prime\prime} \equiv -\displaystyle \sum_{\alpha} \dot{m}^{\prime\prime\prime}_{\alpha} \Delta H_{f,\alpha}
\end{equation}
There is a need, in certain situations, to put an upper bound on the local heat release rate per unit volume. The reason for
this is that FDS is applied over length scales ranging from millimeters to tens of meters, and the resolution of the numerical grid
is sometimes too coarse to work effectively.
A scaling analysis of pool fires by Orloff and de Ris~\cite{Orloff:19th_Symposium} suggests that the spatial average of the
heat release rate of a fire is approximately 1200~kW/m$^3$. FDS uses a less restrictive upper bound on the local heat release rate per unit volume:
\begin{equation}\label{eq:q_bound} 
\dq_{\max}''' = 200/\dx + 2500 \quad \hbox{kW/m}^3 
\end{equation}
The value of 200~kW/m$^2$ is an upper bound on the heat release rate per unit area of flame sheet and $\delta x$ is the characteristic cell size (m). Typically, this bound only affects fires whose value of $Q^*$ is less than one\footnote{The non-dimensional quantity, $Q^*$, is a measure of the fire's heat release rate divided by the
area of its base. It is expressed as $Q^*=\dQ/(\rho_\infty c_p T_\infty \sqrt{g D} D^2)$.}.

\subsection{Reaction Rate} 
\label{Reaction_Rate_Model}

The rate expression (on a fuel basis) for both infinitely fast chemistry and Arrhenius rate chemistry follow the same general form:
\begin{equation}\label{eq:Arrheniusrateeqn}
\frac{\mbox{d}[\hat{X}_\F]}{\mbox{d}t} = -A \; \prod \left([\hat{X}_{\alpha}]^{a_{\alpha}} \right) T^n \; e^{-E/RT} 
\end{equation}
Note that the rate expression can be dependent upon the local temperature as well as concentrations of species that do not directly participate in the reaction. Since FDS solves for mass fractions of lumped species rather than mole fractions of individual species, the only ``species'' that can be consumed or created are the lumped species.  However, any of the primitive species components of those lumped species can participate as a collision species.  Therefore, rather than $\mbox{d}[X_\F]/\mbox{d}t$,  FDS solves for $\mbox{d}\hat{Y}_{\F}/\mbox{d}t$ (recall $\hat{Y}_{\F}$ is mass fraction of the fuel in the mixed zone of the reactor).  Additionally, since it is quicker to determine $\hat{Y}_{\alpha}$ rather than $\hat{X}_i$, the relation $[\hat{X}_i]=\hat{Y}_{\alpha} \rho/W_i$ is used.  Substituting $\hat{Y}_{\alpha}$ into Eq.~(\ref{eq:Arrheniusrateeqn}) and making the appropriate units change to $A$ results in a modified rate equation:

\begin{equation}\label{eq:Arrheniusratemode}
\frac{\mbox{d}\hat{Y}_{\F}}{\mbox{d}t} = -A_{mod} \rho^{\sum (a_{\alpha}) -1} \; \prod \left(\hat{Y}_{\alpha}^{a_{\alpha}} \right) T^n \; e^{-E/RT}; \;\;\; A_{mod} = A \prod \left(W_{\alpha}^{-a_{\alpha}} \right)  
\end{equation}

\subsubsection{Infinitely Fast Reaction}
For fast chemistry reactions, $E$ and $n$ in Eq.~(\ref{eq:Arrheniusratemode}) are set to $0$ which removes the temperature dependence from the rate expression. The species exponents, $a_{\alpha}$, are also set to zero to remove concentration dependence. Finally, the pre-exponential, $A$, is set to $1 \times 10^{16}$. As a result, $\mbox{d}\hat{Y}_\F/\mbox{d}t$ becomes sufficiently large such that all of the fuel (or all of the oxidizer) in the mixed zone of the reactor is consumed in a single time step, effectively making the rate infinite.

\subsubsection{Multiple Infinitely Fast Reactions}   
Special treatment is needed for multiple, infinitely fast, oxygen-limited reactions. No reaction takes precedent over another and each wants to consume all of the available oxidizer.  Thus, the reaction rates must be restricted in some reasonable way. The first step in our approach is to determine the amount of oxidizer that is present in the mixed zone of the reactor. The second step is to calculate the amount of oxidizer that would be needed to stoichiometrically consume all of the fuel in each reaction in the mixed zone. If the required stoichiometric oxidizer amount is larger than the available amount of oxidizer then the reactor is globally fuel rich.

If the cell is determined to be globally fuel rich, then for each of the $n$ reactions the stoichiometric fuel concentration based on the limiting reactant is found:
\begin{equation}\label{eq:stoich_fuel}
\hat{Y}_{F,lim}(n) = \min \left (\hat{Y}_F,-\frac{\hat{Y}_{\alpha}W_{F}}{\nu_{\alpha} W_{\alpha}}\right) \quad ; \quad \mbox{for all reactants, $\alpha$, in reaction $n$}
\end{equation}
To prevent more than the available amount of oxidizer from being consumed, a weight factor, $w(n)$, for the $n$th reaction is calculated based on the limiting amount of fuel:
\begin{equation}\label{eq:fuel_weight}
w(n) = \frac{\hat{Y}_{F,lim}(n)}{\sum_n \, \hat{Y}_{F,lim}(n)}
\end{equation}
The limiting change in fuel for the $n^{th}$ reaction becomes
\begin{equation}\label{eq:fuel_rate}
\Delta \hat{Y}_{F}(n) = \hat{Y}_{F}(n)\,w(n)
\end{equation}

\paragraph{Example: Oxygen-limited, Premixed Methane-Propane Combustion} Show a simple example.

\subsubsection{Arrhenius Reaction}
There are conditions under which the local temperature and species concentrations support the computation of the reaction rate.  One set of conditions is where the reacting regions of the flow can be considered a well-stirred reactor.  The other is during a DNS calculation.  In the first case rather than a reacting surface, there is a reacting volume.  In the second case, the fine grid resolution enables the direct modeling of the diffusion of chemical species (fuel,
oxygen, and combustion products).  This allows the flame to be resolved in a DNS calculation.  Under conditions where the local gas
temperatures can be used to determine the reaction kinetics, Arrhenius rates can be used.


\subsection{Local Extinction}

\label{extinction}

The physical limitation of the mixing-controlled reaction model described in the previous section is that it assumes that fuel and oxygen burn instantaneously when mixed. For large-scale, well-ventilated
fires, this is a good assumption. However, if a fire is in an
under-ventilated compartment, or if a suppression agent like water
mist or CO$_2$ is introduced, or if the shear layer between fuel and oxidizing streams
has a sufficiently large local strain rate,
fuel and oxygen may mix but may not burn.
The physical mechanisms underlying these phenomena are complex, and
even simplified models still rely on an accurate prediction
of the flame temperature and local strain rate.
Subgrid-scale modeling of gas phase suppression and
extinction is still an area of active research in the combustion
community.

Simple empirical rules can be used to predict local
extinction based on the species and temperature present in the flame sheet.  The FDS extinction model consists of two parts based on the critical flame temperature \cite{SFPE:Beyler}. The first, checks to see if the local temperature is above an auto-ignition temperature for the fuel.  If the temperature is too low, then combustion will not occur.  Note that this temperature is by default set to absolute zero so that typical users do not need to specify an ignition source.  The second part the concept of a limiting flame temperature.  If the local combustion cannot raise the local temperature above the limiting flame temperature, then combustion will not occur. If either criteria is failed, then there is no chemical reaction and $\dot{m}^{\prime\prime\prime}_{\alpha}=0$. This is done in the following steps:

\begin{enumerate}
\item Search over all reactant species to find the limiting lumped species and express that species in terms of the reaction's fuel:

\be \Delta \hat{Y}_{\F} = \min_{\alpha \; = \; reactant} \left(\frac{\hat{Y}_{\alpha} W_\F}{W_i \nu_i} \right) \ee
If fuel is the limiting reactant then $\Delta \hat{Y}_{\F}$ is the local fuel mass fraction. If the oxidizer is the limiting reactant then $\Delta \hat{Y}_{\F}$ is the mass fraction of fuel in stoichiometric proportion to oxidizer mass fraction.
\item Store $\Delta \hat{Y}_{\F}$, remove that amount of fuel from the local gas, and renormalize the mass fractions to account for the removal of fuel.
\item Search over all the updated non-fuel reactant species in the gas to determine the limiting reactant.  This defines how much air is required to burn the fuel:

\be \Delta \hat{Y}_{air} = \min_{\alpha \; = \; non-fuel \; reactant} \left(\frac{\Delta \hat{Y}_{\F} W_i \nu_i}{Z_i W_\F} \right) \ee
Note: $\Delta \hat{Y}_{\mbox{air}}$ is in stoichiometric proportion to $\Delta \hat{Y}_{\F}$.
\item Compute the enthalpy for the fuel and the air at both the current temperature and the limiting flame temperature (LFT).
\item Combustion is allowed if 

\be \Delta \hat{Y}_{\mbox{air}} h_{\mbox{air}}(T)+\Delta \hat{Y}_{\F} \left( h_\F(T)+\Delta H_\F \right) > \Delta \hat{Y}_{\mbox{air}} h_{\mbox{air}}(T_{LFT})+ \Delta \hat{Y}_{\F} h_\F(T_{LFT}) \ee

\end{enumerate}

\subsection{Time Integration of Chemical Reactions}
\label{sec:reac_time_integration}

\subsubsection{Single Step, Mixing-Controlled Reaction Rates}
For single-step chemical reactions with mixing-controlled reaction rates, an explicit Euler scheme is used to solve the system of ODEs that determine the chemical mass production rate, $\dot{m}^{\prime\prime\prime}_{\alpha}$. This is the default integration mechanism used in FDS.

\subsubsection{Other Chemistry Models}

For anything other than single step, mixing controlled chemistry a fourth-order explicit integrator with error control is used.  Since chemical timescales are often fast with respect to the hydrodynamic timescales, the solver uses subtimesteps during time integration of the chemical reactions to maintain the specified error tolerance.  Time integration is halted if no reactants are present or if the local heat release rate exceeds maximum allowable values.

More information on the numerical methods of the integrators can be found in Appendix~\ref{chemistry_integration}.

